<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Token Card Management System</title>
<style>
* { margin:0; padding:0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; color: #333; padding-top: 100px; }
header {
  position: fixed; top:0; left:0; right:0;
  background:#0d6efd; color:#fff; padding:20px 30px;
  box-shadow:0 4px 8px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; z-index:1000;
}
header h1 { font-size:20px; letter-spacing:1px; }
header h2 { font-size:16px; font-weight:400; opacity:0.9; }
.section { margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
select, input[type="text"], input[type="number"] { padding:8px 10px; margin-right:5px; border-radius:6px; border:1px solid #ccc; outline:none; transition:0.3s; }
select:hover, input:hover { border-color:#0d6efd; }
input:focus, select:focus { border-color:#0d6efd; box-shadow:0 0 5px rgba(13,110,253,0.5); }
button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:500; transition:0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
button:hover { opacity:0.9; transform:translateY(-1px); }
.save-btn { background: linear-gradient(90deg,#28a745,#218838); color:#fff; position:fixed; bottom:20px; right:20px; z-index:500; }
.delete-btn { background: linear-gradient(90deg,#dc3545,#c82333); color:#fff; }
.add-btn { background: linear-gradient(90deg,#0d6efd,#0056b3); color:#fff; }
.back-btn { background: linear-gradient(90deg,#6c757d,#495057); color:#fff; margin-left:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
th, td { padding:10px; text-align:center; border-bottom:1px solid #eee; }
th { background:#0d6efd; color:#fff; text-transform:uppercase; font-size:14px;}
tr:hover { background:#f1f5f9; }
td input, td select { width:90%; }
.active-cell { background-color: #d4edda; color:#155724; font-weight:600; border-radius:4px; }
.lost-cell { background-color: #f8d7da; color:#721c24; font-weight:600; border-radius:4px; cursor:pointer; }
.damage-cell { background-color: #fff3cd; color:#856404; font-weight:600; border-radius:4px; cursor:pointer; }
.error-cell { background-color: #d1ecf1; color:#0c5460; font-weight:600; border-radius:4px; }
.inactive-cell { background-color: #e2e3e5; color:#6c757d; font-weight:600; border-radius:4px; }
#viewControls { display:flex; align-items:center; flex-wrap: wrap; gap:10px; margin-bottom:10px; }
#viewContainer { max-height:70vh; overflow-y:auto; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:2000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; min-width:300px; max-width:400px; text-align:left; }
.modal-content h3 { margin-bottom:10px; }
.modal-content p { margin:5px 0; }
@media(max-width:768px){
  body { padding-top:140px; }
  header { flex-direction:column; align-items:flex-start; }
  table, td, th { font-size:12px; padding:6px; }
  input, select, button { font-size:12px; }
}
</style>
</head>
<body>

<header>
  <h1>BALAJI ACTION BUILDWELL PVT. LTD.</h1>
  <h2>Token Card Management System</h2>
</header>

<div class="section">
  <h3>Select Plant</h3>
  <select id="plantSelect">
    <option value="">-- Select Plant --</option>
    <option value="C34A">C34A</option>
    <option value="C2">C2</option>
    <option value="C3">C3</option>
    <option value="Internal Vehicle">Internal Vehicle</option>
  </select>
</div>

<div id="plantSummary" class="section"></div>

<div id="addTokenSection" class="section" style="display:none;">
  <div style="margin-top:10px;">
    <input type="number" id="quantityInput" placeholder="Quantity">
    <button class="add-btn" onclick="addQuantityRows()">Add Token Quantity</button>
    <input type="number" id="startSeries" placeholder="Start">
    <input type="number" id="endSeries" placeholder="End">
    <button class="add-btn" onclick="addSeriesRows()">Add Token by Series</button>
    <button class="add-btn" onclick="viewTokens()">View Tokens</button>
    <button class="delete-btn" onclick="deleteAllTokens()">Delete All Tokens</button>
    <button class="back-btn" onclick="backToPlantSummary()">Back</button>
  </div>
</div>

<table id="tokenTable" style="display:none;">
  <thead>
    <tr>
      <th>S.No.</th>
      <th>Token Number</th>
      <th>Plant</th>
      <th>Status</th>
      <th>Remark</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tokenBody"></tbody>
</table>

<div id="viewControls" class="section" style="display:none;">
  <div id="viewSummary"></div>
  <label>Status Filter: </label>
  <select id="statusFilterTop" onchange="filterView()">
    <option value="All">All Status</option>
    <option value="Active">Active</option>
    <option value="Lost">Lost</option>
    <option value="Damage">Damage</option>
    <option value="Error">Error</option>
    <option value="Inactive">Inactive</option>
  </select>
  <input type="text" id="searchTokenTop" placeholder="Search Token Number" oninput="filterView()">
  <button class="add-btn" onclick="exportToExcel()">Export to Excel</button>
  <button class="back-btn" onclick="backToAdd()">Back</button>
</div>

<div id="viewContainer" style="display:none;">
  <table id="viewTable">
    <thead>
      <tr>
        <th>S.No.</th>
        <th>Token Number</th>
        <th>Plant</th>
        <th>Status</th>
        <th>Remark</th>
      </tr>
    </thead>
    <tbody id="viewBody"></tbody>
  </table>
</div>

<!-- Token Detail Modal -->
<div id="tokenDetailModal" class="modal">
  <div class="modal-content">
    <h3>Token Details</h3>
    <div id="tokenDetailContent"></div>
    <button onclick="closeTokenDetailModal()" class="save-btn" style="position:relative; bottom:auto; right:auto;">Close</button>
  </div>
</div>

<div style="margin:15px 0;">
  <button class="save-btn" onclick="saveAll()">Save All Tokens</button>
</div>

<script>
const API_TOKEN = "http://localhost:3000/api/tokens";
const API_GATE  = "http://localhost:3000/api/gate";

let selectedPlant = "";
let loggedInUser = localStorage.getItem("loggedInUser") || "Unknown User";
let tokenData = [];
let gateEntryData = [];

let userMap = {
  "102496":"PAWAN KUMAR","104115":"NIKHIL SAH","104229":"SANJAY SINGH",
  "105838":"NEK CHANDRA","103962":"NARESH YADAV","105942":"MANISH PRAKASH",
  "104127":"RAJENDRA BATHIYAL","105261":"PANKAJ","106564":"SURAJ JANOTI",
  "106408":"KRISHNA SINGH","106491":"ANIL BISHT","106443":"SHUBHAM MITTAL",
  "107002":"AKASH KATIYAR","103451":"PRAKASH FULERA","107388":"ANUJ KUSHWAH",
  "103998":"ROHIT KOKILA"
};
let loggedUserName = (userMap[loggedInUser] || "UNKNOWN USER").toUpperCase();

/* ================== INIT ================== */
loadPlantSummary();

document.getElementById("plantSelect").addEventListener("change", async function(){
  selectedPlant = this.value;
  hideAllSections();

  if(!selectedPlant){
    loadPlantSummary();
    return;
  }

  if(selectedPlant === "Internal Vehicle"){
    document.getElementById("tokenTable").style.display="table";
    await loadInternalVehicleData();
  }else{
    document.getElementById("addTokenSection").style.display="block";
    document.getElementById("tokenTable").style.display="table";
    await loadOldData();
  }
});

/* ================== COMMON ================== */
function hideAllSections(){
  ["addTokenSection","tokenTable","viewTable","viewControls","viewContainer"]
  .forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display="none";
  });
}

/* ================== PLANT SUMMARY ================== */
async function loadPlantSummary(){
  const plants=["C34A","C2","C3","Internal Vehicle"];
  let html='<h4>Plant Token Summary</h4><table><tr><th>Plant</th><th>Total</th><th>Active</th><th>Lost</th><th>Damage</th><th>Error</th><th>Transferred</th></tr>';

  for(const plant of plants){
    const res = await fetch(`${API_TOKEN}/plant/${plant}`);
    const data = await res.json();

    html+=`<tr>
      <td>${plant}</td>
      <td>${data.length}</td>
      <td class="active-cell">${data.filter(x=>x.status==="Active").length}</td>
      <td class="lost-cell">${data.filter(x=>x.status==="Lost").length}</td>
      <td class="damage-cell">${data.filter(x=>x.status==="Damage").length}</td>
      <td class="error-cell">${data.filter(x=>x.status==="Error").length}</td>
      <td class="inactive-cell">${data.filter(x=>x.status==="Transferred").length}</td>
    </tr>`;
  }

  html+="</table>";
  document.getElementById("plantSummary").innerHTML=html;
  document.getElementById("plantSummary").style.display="block";
}

/* ================== LOAD TOKENS ================== */
async function loadOldData(){
  const res = await fetch(`${API_TOKEN}/plant/${selectedPlant}`);
  tokenData = await res.json();

  const tbody=document.getElementById("tokenBody");
  tbody.innerHTML="";

  tokenData.forEach(t=>{
    addRow(t.tokenNo,t.status,t.remark,false,t.updatedDateTime,t.shiftPerson,t.transferredTo,t._id);
  });
}

/* ================== ADD ROW ================== */
function addRow(tokenNo="",status="Active",remark="",isNew=true,dt="",user="",transferredTo=null,id=null){
  const tbody=document.getElementById("tokenBody");
  let tr=document.createElement("tr");
  tr.dataset.id=id||"";

  tr.innerHTML=`
    <td>${tbody.children.length+1}</td>
    <td><input class="tokenNo" value="${tokenNo}"></td>
    <td>${selectedPlant}</td>
    <td>
      <select class="statusSelect" onchange="updateRowColor(this)">
        ${["Active","Inactive","Lost","Damage","Error","Transferred"]
          .map(s=>`<option ${s===status?"selected":""}>${s}</option>`).join("")}
      </select>
    </td>
    <td><input class="remarkInput" value="${remark||""}"></td>
    <td>
      ${isNew?`<button onclick="saveSingleRow(this)">Save</button>`:""}
      <button class="delete-btn" onclick="deleteRow(this)">Delete</button>
    </td>
  `;
  updateRowColor(tr.querySelector(".statusSelect"));
  tbody.appendChild(tr);
}

/* ================== SAVE SINGLE ================== */
async function saveSingleRow(btn){
  const row=btn.closest("tr");
  const payload={
    tokenNo:row.querySelector(".tokenNo").value,
    plant:selectedPlant,
    status:row.querySelector(".statusSelect").value,
    remark:row.querySelector(".remarkInput").value,
    updatedDateTime:new Date().toLocaleString(),
    shiftPerson:loggedUserName
  };

  const res=await fetch(API_TOKEN,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const saved=await res.json();
  row.dataset.id=saved._id;
  btn.remove();
  loadPlantSummary();
}

/* ================== DELETE TOKEN ================== */
async function deleteRow(btn){
  const row=btn.closest("tr");
  const id=row.dataset.id;
  if(id){
    await fetch(`${API_TOKEN}/${id}`,{method:"DELETE"});
  }
  row.remove();
  reorderSerial();
  loadPlantSummary();
}

/* ================== INTERNAL VEHICLE ================== */
async function loadInternalVehicleData(){
  const res=await fetch(API_GATE);
  gateEntryData=await res.json();

  const tbody=document.getElementById("tokenBody");
  tbody.innerHTML="";
  let i=1;

  gateEntryData.forEach(g=>{
    if(!g.saved) return;
    let tr=document.createElement("tr");
    tr.dataset.id=g._id;

    tr.innerHTML=`
      <td>${i++}</td>
      <td>${g.token}</td>
      <td>${g.plant}</td>
      <td>
        <select class="statusSelect" disabled>
          ${["Active","Lost","Damage","Error"]
            .map(s=>`<option ${s===g.status?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>
      <td><input class="remarkInput" value="${g.remark||""}" disabled></td>
      <td>
        <button onclick="editInternalVehicleRow(this)">Edit</button>
        <button class="delete-btn" onclick="deleteInternalVehicleRow(this)">Delete</button>
      </td>`;
    updateRowColor(tr.querySelector(".statusSelect"));
    tbody.appendChild(tr);
  });
}

/* ================== EDIT INTERNAL ================== */
async function editInternalVehicleRow(btn){
  const row=btn.closest("tr");
  const select=row.querySelector(".statusSelect");
  const remark=row.querySelector(".remarkInput");

  if(btn.innerText==="Edit"){
    select.disabled=false; remark.disabled=false;
    btn.innerText="Save"; return;
  }

  await fetch(`${API_GATE}/${row.dataset.id}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:select.value,remark:remark.value})
  });

  select.disabled=true; remark.disabled=true;
  btn.innerText="Edit";
  loadPlantSummary();
}

/* ================== DELETE INTERNAL ================== */
async function deleteInternalVehicleRow(btn){
  const row=btn.closest("tr");
  await fetch(`${API_GATE}/${row.dataset.id}`,{method:"DELETE"});
  row.remove();
  loadPlantSummary();
}

/* ================== UI HELPERS ================== */
function reorderSerial(){
  document.querySelectorAll("#tokenBody tr")
    .forEach((r,i)=>r.children[0].innerText=i+1);
}

function updateRowColor(select){
  const td=select.parentElement;
  td.className="";
  td.classList.add(
    select.value==="Active"?"active-cell":
    select.value==="Lost"?"lost-cell":
    select.value==="Damage"?"damage-cell":
    select.value==="Error"?"error-cell":"inactive-cell"
  );
}
</script>


</body>
</html>
