<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WOOD BILL SUBMIT REGISTER</title>
  <style>
    * {
      text-transform: uppercase;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background-color: #0f2027;
      color: #00ffe7;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
      touch-action: manipulation;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 5px #00ffe7;
      margin-top: 0;
    }
    button {
      padding: 12px 16px;
      margin: 10px 5px;
      border: 1px solid #00ffe7;
      background: transparent;
      color: #00ffe7;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      box-shadow: 0 0 10px #00ffe7;
    }
    th, td {
      padding: 10px;
      border: 1px solid #00ffe7;
      text-align: center;
    }
    input, select {
      width: 100%;
      background: #111;
      color: #00ffe7;
      border: 1px solid #00ffe7;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
    }
    #filters {
      display: none;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #filters input, #filters select {
      width: auto;
      margin: 0;
    }
    .readonly input, .readonly select {
      pointer-events: none;
      background: #1c1c1c;
    }
    
    /* Mobile Styles */
    @media only screen and (max-width: 768px) {
      body {
        padding: 10px;
        -webkit-overflow-scrolling: touch;
      }
      
      #fillTableSection table, 
      #viewSection table {
        display: none;
      }
      
      /* Mobile Form Styles */
      .mobile-form {
        display: block;
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        border: 1px solid #00ffe7;
        border-radius: 8px;
        box-shadow: 0 0 10px #00ffe7;
      }
      
      .mobile-form .form-group {
        margin-bottom: 20px;
      }
      
      .mobile-form label {
        display: block;
        margin-bottom: 8px;
        font-size: 16px;
      }
      
      .mobile-form input, 
      .mobile-form select {
        width: 100%;
        padding: 14px;
        font-size: 18px;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      
      .mobile-form input[type="number"] {
        -moz-appearance: textfield;
      }
      
      .mobile-form input[type="number"]::-webkit-outer-spin-button,
      .mobile-form input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      
      .mobile-form .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
      }
      
      .mobile-form .form-actions button {
        flex: 1;
        margin: 0 8px;
        padding: 14px;
        font-size: 18px;
      }
      
      /* Mobile View Styles */
      .mobile-view-item {
        border: 1px solid #00ffe7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 0 5px #00ffe7;
      }
      
      .mobile-view-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 16px;
      }
      
      .mobile-view-label {
        font-weight: bold;
        color: #00b3a1;
      }
      
      /* Show mobile elements only on mobile */
      .mobile-only {
        display: none;
      }
      
      @media only screen and (max-width: 768px) {
        .mobile-only {
          display: block;
        }
        .desktop-only {
          display: none;
        }
      }
    }
  </style>
</head>
<body onload="initPage()">

  <h2>WOOD BILL SUBMIT REGISTER</h2>

  <button onclick="showFill()">FILL REPORT</button>
  <button id="addRowBtn" onclick="addRow()">ADD ROW</button>
  <button onclick="showView()">VIEW REPORT</button>

  <!-- Filters -->
  <div id="filters" class="desktop-only">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="receiverFilter">
      <option value="">Filter Receiver</option>
    </select>
    <select id="submittedByFilter">
      <option value="">Filter Submitted By</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search...">
    <button onclick="filterView()">Search</button>
  </div>

  <!-- Fill Table (Desktop) -->
  <div id="fillTableSection" class="desktop-only">
    <table id="fillTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <!-- Mobile Form (Hidden on desktop) -->
  <div id="mobileFillForm" class="mobile-only" style="display: none;">
    <form id="mobileDataForm" class="mobile-form" onsubmit="event.preventDefault(); saveMobileForm();">
      <div class="form-group">
        <label for="mobileSapDate">SAP DATE</label>
        <input type="date" id="mobileSapDate" required>
      </div>
      <div class="form-group">
        <label for="mobileBillDate">BILL SUBMIT DATE</label>
        <input type="date" id="mobileBillDate" required>
      </div>
      <div class="form-group">
        <label for="mobileQuantity">QUANTITY</label>
        <input type="number" id="mobileQuantity" min="1" required 
               pattern="[0-9]*" inputmode="numeric">
      </div>
      <div class="form-group">
        <label for="mobileSubmitTime">SUBMIT TIME</label>
        <input type="time" id="mobileSubmitTime" required>
      </div>
      <div class="form-group">
        <label for="mobileReceiverName">RECEIVER NAME</label>
        <input type="text" id="mobileReceiverName" required
               autocapitalize="characters">
      </div>
      <div class="form-group">
        <label for="mobileSubmittedBy">SUBMITTED BY</label>
        <input type="text" id="mobileSubmittedBy" value="${currentUser}" readonly>
      </div>
      <div class="form-group">
        <label for="mobilePlant">PLANT</label>
        <select id="mobilePlant" required>
          <option value="">Select</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="button" onclick="cancelMobileForm()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
  
  <!-- Mobile View (Hidden on desktop) -->
  <div id="mobileViewSection" class="mobile-only" style="display: none;">
    <!-- Mobile filters -->
    <div style="margin: 15px 0;">
      <input type="date" id="mobileStartDate" style="width: 48%;">
      <input type="date" id="mobileEndDate" style="width: 48%; float: right;">
      <select id="mobileReceiverFilter" style="width: 100%; margin-top: 10px;">
        <option value="">Filter Receiver</option>
      </select>
      <select id="mobileSubmittedByFilter" style="width: 100%; margin-top: 10px;">
        <option value="">Filter Submitted By</option>
      </select>
      <input type="text" id="mobileSearchBox" placeholder="Search..." style="width: 100%; margin-top: 10px;">
      <button onclick="filterMobileView()" style="width: 100%; margin-top: 10px;">Search</button>
    </div>
    
    <!-- Mobile view items will be inserted here -->
    <div id="mobileViewItems"></div>
  </div>

  <!-- View Table (Desktop) -->
  <div id="viewSection" class="desktop-only" style="display: none;">
    <table id="viewTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = (localStorage.getItem("username") || "unknown").toUpperCase();
  let unsavedRowExists = false;
  let isMobile = window.innerWidth <= 768;
  let editingId = null;
  let formData = {}; // To store form data when switching views

  // Detect screen size changes
  window.addEventListener('resize', function() {
    isMobile = window.innerWidth <= 768;
    if (isMobile) {
      if (document.getElementById("fillTableSection").style.display !== "none") {
        showFill();
      } else if (document.getElementById("viewSection").style.display !== "none") {
        showView();
      }
    } else {
      if (document.getElementById("mobileFillForm").style.display !== "none") {
        showFill();
      } else if (document.getElementById("mobileViewSection").style.display !== "none") {
        showView();
      }
    }
  });

  document.addEventListener("DOMContentLoaded", initPage);

  function initPage() {
    showFill();
    loadSavedData();
    
    // Desktop event listeners
    document.getElementById("searchBox").addEventListener("input", filterView);
    document.getElementById("startDate").addEventListener("change", filterView);
    document.getElementById("endDate").addEventListener("change", filterView);
    document.getElementById("receiverFilter").addEventListener("change", filterView);
    document.getElementById("submittedByFilter").addEventListener("change", filterView);
    
    // Mobile event listeners
    document.getElementById("mobileSearchBox").addEventListener("input", filterMobileView);
    document.getElementById("mobileStartDate").addEventListener("change", filterMobileView);
    document.getElementById("mobileEndDate").addEventListener("change", filterMobileView);
    document.getElementById("mobileReceiverFilter").addEventListener("change", filterMobileView);
    document.getElementById("mobileSubmittedByFilter").addEventListener("change", filterMobileView);

    // Save form data when leaving the page
    window.addEventListener('beforeunload', function() {
      if (isMobile && document.getElementById("mobileFillForm").style.display !== "none") {
        saveFormData();
      }
    });
  }

  function saveFormData() {
    formData = {
      sapDate: document.getElementById("mobileSapDate").value,
      billDate: document.getElementById("mobileBillDate").value,
      quantity: document.getElementById("mobileQuantity").value,
      submitTime: document.getElementById("mobileSubmitTime").value,
      receiverName: document.getElementById("mobileReceiverName").value,
      plant: document.getElementById("mobilePlant").value
    };
  }

  function restoreFormData() {
    if (formData) {
      document.getElementById("mobileSapDate").value = formData.sapDate || "";
      document.getElementById("mobileBillDate").value = formData.billDate || "";
      document.getElementById("mobileQuantity").value = formData.quantity || "";
      document.getElementById("mobileSubmitTime").value = formData.submitTime || "";
      document.getElementById("mobileReceiverName").value = formData.receiverName || "";
      document.getElementById("mobilePlant").value = formData.plant || "";
    }
  }

  function showFill() {
    if (isMobile) {
      document.getElementById("mobileFillForm").style.display = "block";
      document.getElementById("mobileViewSection").style.display = "none";
      document.getElementById("addRowBtn").style.display = "inline-block";
      restoreFormData();
    } else {
      document.getElementById("fillTableSection").style.display = "block";
      document.getElementById("viewSection").style.display = "none";
      document.getElementById("filters").style.display = "none";
      document.getElementById("addRowBtn").style.display = "inline-block";
    }
  }

  function showView() {
    if (isMobile) {
      if (document.getElementById("mobileFillForm").style.display !== "none") {
        saveFormData();
      }
      document.getElementById("mobileFillForm").style.display = "none";
      document.getElementById("mobileViewSection").style.display = "block";
      document.getElementById("addRowBtn").style.display = "none";
      loadMobileViewData();
    } else {
      document.getElementById("fillTableSection").style.display = "none";
      document.getElementById("viewSection").style.display = "block";
      document.getElementById("filters").style.display = "block";
      document.getElementById("addRowBtn").style.display = "none";
      loadViewData();
    }
  }

  function addRow() {
    if (isMobile) {
      document.getElementById("mobileFillForm").style.display = "block";
      unsavedRowExists = true;
      document.getElementById("mobileFillForm").scrollIntoView({ behavior: 'smooth' });
      
      // Clear form when adding new row (but preserve if editing)
      if (!editingId) {
        document.getElementById("mobileSapDate").value = "";
        document.getElementById("mobileBillDate").value = "";
        document.getElementById("mobileQuantity").value = "";
        document.getElementById("mobileSubmitTime").value = "";
        document.getElementById("mobileReceiverName").value = "";
        document.getElementById("mobilePlant").value = "";
      }
    } else {
      if (unsavedRowExists) {
        alert("Please save the current row before adding a new one.");
        return;
      }

      const tbody = document.querySelector("#fillTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="status">üìù</td>
        <td><input type="date"></td>
        <td><input type="date"></td>
        <td><input type="number" min="1"></td>
        <td><input type="time"></td>
        <td><input type="text"></td>
        <td><input type="text" value="${currentUser}" disabled></td>
        <td>
          <select>
            <option value="">Select</option>
            <option value="C34A">C34A</option>
            <option value="C2">C2</option>
            <option value="C3">C3</option>
          </select>
        </td>
        <td><button onclick="saveRow(this)">Save</button></td>
      `;
      tbody.prepend(row);
      unsavedRowExists = true;
    }
  }
  
  function cancelMobileForm() {
    if (confirm("Are you sure you want to cancel? Any unsaved changes will be lost.")) {
      document.getElementById("mobileFillForm").style.display = "none";
      unsavedRowExists = false;
      editingId = null;
      formData = {};
    }
  }
  
  async function saveMobileForm() {
    const form = document.getElementById("mobileDataForm");
    const data = {
      sapDate: form.mobileSapDate.value,
      billDate: form.mobileBillDate.value,
      quantity: form.mobileQuantity.value,
      submitTime: form.mobileSubmitTime.value,
      receiverName: form.mobileReceiverName.value.toUpperCase(),
      submittedBy: currentUser,
      plant: form.mobilePlant.value.toUpperCase()
    };

    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || !data.receiverName || !data.plant) {
      alert("Please fill all fields.");
      return;
    }

    const endpoint = editingId ? `/api/wood-bill/${editingId}` : "/api/wood-bill";
    const method = editingId ? "PUT" : "POST";

    try {
      const res = await fetch(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        alert("Data saved successfully!");
        document.getElementById("mobileFillForm").style.display = "none";
        unsavedRowExists = false;
        editingId = null;
        formData = {};
        loadSavedData();
      } else {
        alert("Save failed: " + (result.message || ""));
      }
    } catch (error) {
      alert("Error saving data: " + error.message);
    }
  }

  // ... [rest of the JavaScript code remains the same as in previous version] ...
  // Include all the other functions from the previous version (loadSavedData, loadMobileViewData, etc.)

</script>
</body>
</html>
