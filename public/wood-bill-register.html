<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WOOD BILL SUBMIT REGISTER</title>
  <style>
    * {
      text-transform: uppercase;
      box-sizing: border-box;
    }
    body {
      background-color: #0f2027;
      color: #00ffe7;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 5px #00ffe7;
      margin: 0;
      flex-grow: 1;
    }
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      border: 1px solid #00ffe7;
      background: transparent;
      color: #00ffe7;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      background: #00ffe7;
      color: #0f2027;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      box-shadow: 0 0 10px #00ffe7;
    }
    th, td {
      padding: 10px;
      border: 1px solid #00ffe7;
      text-align: center;
    }
    th {
      background: rgba(0, 255, 231, 0.1);
    }
    input, select {
      width: 100%;
      background: #111;
      color: #00ffe7;
      border: 1px solid #00ffe7;
      padding: 8px;
      border-radius: 4px;
    }
    input:focus, select:focus {
      outline: 1px solid #00ffe7;
      box-shadow: 0 0 5px #00ffe7;
    }
    input:read-only, input:disabled {
      background: #1a1a1a;
      cursor: not-allowed;
    }
    .status-pending {
      color: #ff9900;
      font-weight: bold;
    }
    .status-received {
      color: #00ff00;
      font-weight: bold;
    }
    .status-security {
      color: #00ccff;
      font-weight: bold;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .action-buttons button {
      padding: 5px 10px;
      margin: 0;
      font-size: 12px;
      min-width: 60px;
    }
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.3s;
    }
    .success {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
    }
    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #ff0000;
      color: #ff0000;
    }
    .warning {
      background: rgba(255, 255, 0, 0.2);
      border: 1px solid #ffff00;
      color: #ffff00;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>

  <div class="header">
    <h2>WOOD BILL SUBMIT REGISTER</h2>
    <div class="nav-buttons">
      <button onclick="showFill()">FILL REPORT</button>
      <button id="addRowBtn" onclick="addNewRow()">ADD NEW ROW</button>
      <button onclick="showView()">VIEW REPORT</button>
    </div>
  </div>

  <!-- Fill Table -->
  <div id="fillTableSection">
    <table id="fillTable">
      <thead>
        <tr>
          <th width="50">S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>STATUS</th>
          <th width="150">ACTIONS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- View Table -->
  <div id="viewSection" style="display: none;">
    <table id="viewTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = (localStorage.getItem("username") || "unknown").toUpperCase();
  let isEditingMode = false;
  let today = new Date().toISOString().split('T')[0];

  document.addEventListener("DOMContentLoaded", initPage);

  function initPage() {
    loadSavedData();
    showFill();
  }

  function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }

  function showFill() {
    document.getElementById("fillTableSection").style.display = "block";
    document.getElementById("viewSection").style.display = "none";
    document.getElementById("addRowBtn").style.display = "inline-block";
  }

  function showView() {
    document.getElementById("fillTableSection").style.display = "none";
    document.getElementById("viewSection").style.display = "block";
    document.getElementById("addRowBtn").style.display = "none";
    loadViewData();
  }

  function addNewRow() {
    if (isEditingMode) {
      showAlert('Please save or cancel the current edit first!', 'warning');
      return;
    }

    const tbody = document.querySelector("#fillTable tbody");
    const row = document.createElement("tr");
    row.className = "editing-row";
    row.innerHTML = `
      <td>üìù</td>
      <td><input type="date" value="${today}" id="sapDate"></td>
      <td><input type="date" value="${today}" id="billDate"></td>
      <td><input type="number" min="1" placeholder="Quantity" id="quantity"></td>
      <td><input type="time" value="${new Date().toTimeString().slice(0,5)}" id="submitTime"></td>
      <td><input type="text" id="receiverName" readonly placeholder="Auto-filled by plant"></td>
      <td><input type="text" value="${currentUser}" readonly id="submittedBy"></td>
      <td>
        <select id="plantSelect" onchange="handlePlantChange(this)">
          <option value="">Select Plant</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
      </td>
      <td id="statusCell">-</td>
      <td class="action-buttons">
        <button onclick="saveRow(this)" style="background:#00ff00;color:#000">Save</button>
        <button onclick="cancelAdd(this)" style="background:#ff0000;color:#fff">Cancel</button>
      </td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
    isEditingMode = true;
  }

  function handlePlantChange(select) {
    const row = select.closest("tr");
    const receiverInput = row.querySelector("#receiverName");
    const statusCell = row.querySelector("#statusCell");
    
    if (select.value === 'C2' || select.value === 'C34A') {
      receiverInput.value = "SECURITY";
      statusCell.innerHTML = '<span class="status-security">SECURITY</span>';
      receiverInput.readOnly = true;
    } else if (select.value === 'C3') {
      receiverInput.value = "";
      statusCell.innerHTML = '<span class="status-pending">PENDING</span>';
      receiverInput.readOnly = false;
    } else {
      receiverInput.value = "";
      statusCell.innerHTML = '-';
      receiverInput.readOnly = false;
    }
  }

  async function saveRow(btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");
    
    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: parseFloat(inputs[2].value),
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.trim().toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase()
    };

    // Validation
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || 
        !data.plant) {
      showAlert('Please fill all fields!', 'error');
      return;
    }

    if (isNaN(data.quantity) || data.quantity <= 0) {
      showAlert('Please enter valid quantity!', 'error');
      return;
    }

    // C3 ‡§ï‡•á ‡§≤‡§ø‡§è receiver name check
    if (data.plant === 'C3' && !data.receiverName) {
      showAlert('For C3 plant, receiver name is required!', 'error');
      return;
    }

    try {
      const res = await fetch("/api/wood-bill", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Bill saved successfully!', 'success');
        isEditingMode = false;
        loadSavedData();
      } else {
        showAlert(result.message || 'Save failed!', 'error');
      }
    } catch (error) {
      console.error('Save error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  function cancelAdd(btn) {
    const row = btn.closest("tr");
    row.remove();
    isEditingMode = false;
  }

async function loadSavedData() {
  try {
    // Get token from localStorage
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/wood-bill', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const allData = await response.json();
    const tbody = document.querySelector("#fillTable tbody");
    tbody.innerHTML = "";

    if (!Array.isArray(allData)) {
      console.error("Expected array but got:", allData);
      showAlert('Invalid data format received from server!', 'error');
      return;
    }

    // Sort by date (newest first)
    allData.sort((a, b) => new Date(b.sapDate) - new Date(a.sapDate));

    allData.forEach((d, index) => {
      const sapDate = d.sapDate ? d.sapDate.split('T')[0] : '';
      const billDate = d.billDate ? d.billDate.split('T')[0] : '';
      
      let statusText = "";
      let statusClass = "";
      
      if (d.receiverStatus === "Pending by Receiver") {
        statusText = "PENDING";
        statusClass = "status-pending";
      } else if (d.receiverStatus === "Received by Security") {
        statusText = "SECURITY";
        statusClass = "status-security";
      } else if (d.receiverStatus === "Received") {
        statusText = "RECEIVED";
        statusClass = "status-received";
      }
      
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${sapDate}</td>
          <td>${billDate}</td>
          <td>${d.quantity}</td>
          <td>${d.submitTime}</td>
          <td>${d.receiverName || '-'}</td>
          <td>${d.submittedBy}</td>
          <td>${d.plant}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="action-buttons">
            ${d.submittedBy === currentUser && d.receiverStatus !== "Received" ? 
              `<button onclick="editRow(this, '${d._id}')">Edit</button>
               <button onclick="deleteRow(this, '${d._id}')" style="background:#ff0000;color:#fff">Delete</button>` :
              `<span style="color:gray;">Locked</span>`
            }
          </td>
        </tr>
      `;
    });
    
    // Show success message if data loaded
    if (allData.length > 0) {
      console.log(`Loaded ${allData.length} wood bills successfully`);
    }
    
  } catch (error) {
    console.error("Error loading data:", error);
    showAlert(`Failed to load data: ${error.message}`, 'error');
    
    // Show empty state in table
    const tbody = document.querySelector("#fillTable tbody");
    tbody.innerHTML = `
      <tr>
        <td colspan="10" style="text-align: center; padding: 20px; color: #ff9900;">
          ‚ùå Failed to load data. Please check your connection and try again.<br>
          Error: ${error.message}
        </td>
      </tr>
    `;
  }
}
  async function loadViewData() {
    try {
      const res = await fetch("/api/wood-bill");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      const rows = await res.json();
      const tbody = document.querySelector("#viewTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(rows)) {
        console.error("Expected array but got:", rows);
        return;
      }

      // Sort by date (newest first)
      rows.sort((a, b) => new Date(b.sapDate) - new Date(a.sapDate));

      rows.forEach((d, i) => {
        const sapDate = d.sapDate ? d.sapDate.split('T')[0] : '';
        const billDate = d.billDate ? d.billDate.split('T')[0] : '';
        
        let statusText = "";
        let statusClass = "";
        
        if (d.receiverStatus === "Pending by Receiver") {
          statusText = "PENDING";
          statusClass = "status-pending";
        } else if (d.receiverStatus === "Received by Security") {
          statusText = "SECURITY";
          statusClass = "status-security";
        } else if (d.receiverStatus === "Received") {
          statusText = "RECEIVED";
          statusClass = "status-received";
        }
        
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${sapDate}</td>
            <td>${billDate}</td>
            <td>${d.quantity}</td>
            <td>${d.submitTime}</td>
            <td>${d.receiverName || '-'}</td>
            <td>${d.submittedBy}</td>
            <td>${d.plant}</td>
            <td class="${statusClass}">${statusText}</td>
          </tr>
        `;
      });
    } catch (error) {
      console.error("Error loading view data:", error);
      showAlert('Failed to load view data!', 'error');
    }
  }

  async function deleteRow(btn, id) {
    if (!confirm('Are you sure you want to delete this bill?')) {
      return;
    }

    try {
      const res = await fetch(`/api/wood-bill/${id}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Bill deleted successfully!', 'success');
        loadSavedData();
      } else {
        showAlert(result.message || 'Delete failed!', 'error');
      }
    } catch (error) {
      console.error('Delete error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  // Auto-refresh every 30 seconds
  setInterval(() => {
    if (!isEditingMode) {
      loadSavedData();
    }
  }, 30000);
</script>

</body>
</html>
