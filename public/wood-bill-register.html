<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WOOD BILL SUBMIT REGISTER</title>
  <style>
    * {
      text-transform: uppercase;
      box-sizing: border-box;
    }
    body {
      background-color: #0f2027;
      color: #00ffe7;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 5px #00ffe7;
      margin: 0;
      flex-grow: 1;
    }
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      border: 1px solid #00ffe7;
      background: transparent;
      color: #00ffe7;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      background: #00ffe7;
      color: #0f2027;
    }
    button.active {
      background: #00ffe7;
      color: #0f2027;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      box-shadow: 0 0 10px #00ffe7;
    }
    th, td {
      padding: 10px;
      border: 1px solid #00ffe7;
      text-align: center;
    }
    th {
      background: rgba(0, 255, 231, 0.1);
    }
    input, select {
      background: #111;
      color: #00ffe7;
      border: 1px solid #00ffe7;
      padding: 8px;
      border-radius: 4px;
      margin: 5px;
    }
    input:focus, select:focus {
      outline: 1px solid #00ffe7;
      box-shadow: 0 0 5px #00ffe7;
    }
    input:read-only, input:disabled {
      background: #1a1a1a;
      cursor: not-allowed;
    }
    .status-pending {
      color: #ff9900;
      font-weight: bold;
      background: rgba(255, 153, 0, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .status-received {
      color: #00ff00;
      font-weight: bold;
      background: rgba(0, 255, 0, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .status-security {
      color: #00ccff;
      font-weight: bold;
      background: rgba(0, 204, 255, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .action-buttons button {
      padding: 5px 10px;
      margin: 0;
      font-size: 12px;
      min-width: 60px;
    }
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.3s;
    }
    .success {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
    }
    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #ff0000;
      color: #ff0000;
    }
    .warning {
      background: rgba(255, 255, 0, 0.2);
      border: 1px solid #ffff00;
      color: #ffff00;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .filters-section {
      background: rgba(0, 255, 231, 0.05);
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border: 1px solid #00ffe7;
      display: none;
    }
    .filters-section.active {
      display: block;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .filter-row label {
      min-width: 120px;
      color: #00ccff;
    }
    .filter-input {
      flex: 1;
      min-width: 200px;
    }
    .search-box {
      width: 300px;
      padding: 10px;
      font-size: 14px;
    }
    .clear-btn {
      background: rgba(255, 0, 0, 0.1);
      border-color: #ff0000;
      color: #ff0000;
    }
    .clear-btn:hover {
      background: #ff0000;
      color: #fff;
    }
    .pending-row {
      background: rgba(255, 153, 0, 0.05);
    }
    .export-btn {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00ff00;
      color: #00ff00;
    }
    .export-btn:hover {
      background: #00ff00;
      color: #000;
    }
    .locked-action {
      color: #888;
      font-size: 12px;
      font-style: italic;
    }
    .edit-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div class="header">
    <h2>WOOD BILL SUBMIT REGISTER</h2>
    <div class="nav-buttons">
      <button id="fillBtn" class="active" onclick="showFill()">FILL REPORT</button>
      <button id="addRowBtn" onclick="addNewRow()">ADD NEW ROW</button>
      <button id="viewBtn" onclick="showView()">VIEW REPORT</button>
    </div>
  </div>

  <!-- Fill Table -->
  <div id="fillTableSection">
    <table id="fillTable">
      <thead>
        <tr>
          <th width="50">S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>STATUS</th>
          <th width="150">ACTIONS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- View Table with Filters -->
  <div id="viewSection" style="display: none;">
    <!-- Filters Section -->
    <div class="filters-section" id="viewFilters">
      <div class="filter-row">
        <label>üìÖ DATE RANGE:</label>
        <input type="date" id="startDate" class="filter-input" onchange="filterViewData()">
        <span style="color:#00ffe7;">TO</span>
        <input type="date" id="endDate" class="filter-input" onchange="filterViewData()">
      </div>
      
      <div class="filter-row">
        <label>üè≠ PLANT:</label>
        <select id="plantFilter" class="filter-input" onchange="filterViewData()">
          <option value="">ALL PLANTS</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
        
        <label>üìä STATUS:</label>
        <select id="statusFilter" class="filter-input" onchange="filterViewData()">
          <option value="">ALL STATUS</option>
          <option value="Pending by Receiver">PENDING</option>
          <option value="Received by Security">SECURITY</option>
          <option value="Received">RECEIVED</option>
        </select>
      </div>
      
      <div class="filter-row">
        <label>üë§ SUBMITTED BY:</label>
        <select id="submittedByFilter" class="filter-input" onchange="filterViewData()">
          <option value="">ALL USERS</option>
        </select>
        
        <label>üë• RECEIVER:</label>
        <select id="receiverFilter" class="filter-input" onchange="filterViewData()">
          <option value="">ALL RECEIVERS</option>
          <option value="SECURITY">SECURITY</option>
        </select>
      </div>
      
      <div class="filter-row">
        <label>üîç SEARCH:</label>
        <input type="text" id="searchBox" class="filter-input search-box" 
               placeholder="Search by bill number, receiver, plant..." 
               oninput="filterViewData()">
        
        <button onclick="clearFilters()" class="clear-btn">CLEAR FILTERS</button>
        <button onclick="exportToExcel()" class="export-btn">üìä EXPORT EXCEL</button>
      </div>
      
      <div class="filter-row" style="justify-content: space-between;">
        <div>
          <span style="color:#00ccff;">üìä TOTAL RECORDS: <span id="totalRecords">0</span></span>
          <span style="margin-left: 20px; color:#ff9900;">‚è≥ PENDING: <span id="pendingCount">0</span></span>
          <span style="margin-left: 20px; color:#00ff00;">‚úÖ RECEIVED: <span id="receivedCount">0</span></span>
          <span style="margin-left: 20px; color:#00ccff;">üîí SECURITY: <span id="securityCount">0</span></span>
        </div>
        <button onclick="printReport()" style="background:rgba(0,255,231,0.1);">üñ®Ô∏è PRINT REPORT</button>
      </div>
    </div>
    
    <table id="viewTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = (localStorage.getItem("username") || "unknown").toUpperCase();
  let currentUserDate = new Date().toISOString().split('T')[0]; // Today's date for current user
  let isEditingMode = false;
  let today = new Date().toISOString().split('T')[0];
  let allViewData = [];
  let filteredViewData = [];

  document.addEventListener("DOMContentLoaded", function() {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'index.html';
      return;
    }
    
    initPage();
    
    // Set default date range (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
  });

  function initPage() {
    loadSavedData();
    showFill();
  }

  function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }

  function showFill() {
    document.getElementById("fillTableSection").style.display = "block";
    document.getElementById("viewSection").style.display = "none";
    document.getElementById("addRowBtn").style.display = "inline-block";
    document.getElementById("fillBtn").classList.add("active");
    document.getElementById("viewBtn").classList.remove("active");
  }

  function showView() {
    document.getElementById("fillTableSection").style.display = "none";
    document.getElementById("viewSection").style.display = "block";
    document.getElementById("addRowBtn").style.display = "none";
    document.getElementById("viewBtn").classList.add("active");
    document.getElementById("fillBtn").classList.remove("active");
    
    loadViewData();
  }

  function addNewRow() {
    if (isEditingMode) {
      showAlert('Please save or cancel the current edit first!', 'warning');
      return;
    }

    const tbody = document.querySelector("#fillTable tbody");
    const row = document.createElement("tr");
    row.className = "editing-row";
    row.innerHTML = `
      <td>üìù</td>
      <td><input type="date" value="${today}" id="sapDate"></td>
      <td><input type="date" value="${today}" id="billDate"></td>
      <td><input type="number" min="1" placeholder="Quantity" id="quantity"></td>
      <td><input type="time" value="${new Date().toTimeString().slice(0,5)}" id="submitTime"></td>
      <td><input type="text" id="receiverName" readonly placeholder="Auto-filled"></td>
      <td><input type="text" value="${currentUser}" readonly id="submittedBy"></td>
      <td>
        <select id="plantSelect" onchange="handlePlantChange(this)">
          <option value="">Select Plant</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
      </td>
      <td id="statusCell">-</td>
      <td class="action-buttons">
        <button onclick="saveRow(this)" style="background:#00ff00;color:#000">Save</button>
        <button onclick="cancelAdd(this)" style="background:#ff0000;color:#fff">Cancel</button>
      </td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
    isEditingMode = true;
  }

  function handlePlantChange(select) {
    const row = select.closest("tr");
    const receiverInput = row.querySelector("#receiverName");
    const statusCell = row.querySelector("#statusCell");
    
    if (select.value === 'C2' || select.value === 'C34A') {
      receiverInput.value = "SECURITY";
      receiverInput.readOnly = true;
      statusCell.innerHTML = '<span class="status-security">SECURITY</span>';
    } else if (select.value === 'C3') {
      receiverInput.value = "";
      receiverInput.placeholder = "Will be filled after receiving";
      receiverInput.readOnly = true;
      statusCell.innerHTML = '<span class="status-pending">PENDING</span>';
    } else {
      receiverInput.value = "";
      statusCell.innerHTML = '-';
    }
  }

  async function saveRow(btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");
    
    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: parseFloat(inputs[2].value),
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.trim().toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase(),
      userDate: currentUserDate // Store the date when user is creating/editing
    };

    // Validation
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || 
        !data.plant) {
      showAlert('Please fill all fields!', 'error');
      return;
    }

    if (isNaN(data.quantity) || data.quantity <= 0) {
      showAlert('Please enter valid quantity!', 'error');
      return;
    }

    try {
      // Get token from localStorage
      const token = localStorage.getItem('token');
      
      if (!token) {
        showAlert('Please login again!', 'error');
        window.location.href = 'index.html';
        return;
      }
      
      const res = await fetch("/api/wood-bill", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Bill saved successfully!', 'success');
        isEditingMode = false;
        
        if (data.plant === 'C3') {
          showAlert('C3 Bill saved with PENDING status. Wait for receiver to accept in Receive Panel.', 'warning');
        }
        
        loadSavedData();
      } else {
        showAlert(result.message || 'Save failed!', 'error');
      }
    } catch (error) {
      console.error('Save error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  function cancelAdd(btn) {
    const row = btn.closest("tr");
    row.remove();
    isEditingMode = false;
  }

  async function loadSavedData() {
    try {
      const res = await fetch("/api/wood-bill");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      const allData = await res.json();
      const tbody = document.querySelector("#fillTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(allData)) {
        console.error("Expected array but got:", allData);
        return;
      }

      allData.sort((a, b) => new Date(b.sapDate) - new Date(a.sapDate));

      allData.forEach((d, index) => {
        const sapDate = d.sapDate ? d.sapDate.split('T')[0] : '';
        const billDate = d.billDate ? d.billDate.split('T')[0] : '';
        
        let statusText = "";
        let statusClass = "";
        let rowClass = "";
        
        if (d.receiverStatus === "Pending by Receiver") {
          statusText = "PENDING";
          statusClass = "status-pending";
          rowClass = "pending-row";
        } else if (d.receiverStatus === "Received by Security") {
          statusText = "SECURITY";
          statusClass = "status-security";
        } else if (d.receiverStatus === "Received") {
          statusText = "RECEIVED";
          statusClass = "status-received";
        }
        
        // Check if record can be edited/deleted
        // Condition: Same user AND same date (userDate) AND status is not "Received"
        const canEditDelete = (
          d.submittedBy === currentUser && 
          d.userDate === currentUserDate && 
          d.receiverStatus !== "Received"
        );
        
        tbody.innerHTML += `
          <tr class="${rowClass}">
            <td>${index + 1}</td>
            <td>${sapDate}</td>
            <td>${billDate}</td>
            <td>${d.quantity}</td>
            <td>${d.submitTime}</td>
            <td>${d.receiverName || (d.plant === 'C3' ? 'PENDING...' : '-')}</td>
            <td>${d.submittedBy}</td>
            <td>${d.plant}</td>
            <td class="${statusClass}">${statusText}</td>
            <td class="action-buttons">
              ${canEditDelete ? 
                `<button onclick="editRow(this, '${d._id}')">Edit</button>
                 <button onclick="deleteRow(this, '${d._id}')" style="background:#ff0000;color:#fff">Delete</button>` :
                `<span class="locked-action">Locked</span>`
              }
            </td>
          </tr>
        `;
      });
    } catch (error) {
      console.error("Error loading data:", error);
      showAlert('Failed to load data!', 'error');
    }
  }

  async function editRow(btn, id) {
    if (isEditingMode) {
      showAlert('Please save or cancel the current edit first!', 'warning');
      return;
    }

    try {
      const res = await fetch(`/api/wood-bill/${id}`);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      const data = await res.json();
      
      if (!data) {
        showAlert('Record not found!', 'error');
        return;
      }

      // Check if user can edit this record
      if (data.submittedBy !== currentUser || data.userDate !== currentUserDate) {
        showAlert('You can only edit records created by you on the same date!', 'error');
        return;
      }

      if (data.receiverStatus === "Received") {
        showAlert('Cannot edit received bills!', 'error');
        return;
      }

      const row = btn.closest("tr");
      const rowIndex = row.rowIndex;
      const tbody = document.querySelector("#fillTable tbody");
      
      // Create edit row
      const editRow = document.createElement("tr");
      editRow.className = "editing-row";
      editRow.innerHTML = `
        <td>‚úèÔ∏è</td>
        <td><input type="date" value="${data.sapDate ? data.sapDate.split('T')[0] : today}" id="editSapDate"></td>
        <td><input type="date" value="${data.billDate ? data.billDate.split('T')[0] : today}" id="editBillDate"></td>
        <td><input type="number" min="1" value="${data.quantity}" id="editQuantity"></td>
        <td><input type="time" value="${data.submitTime}" id="editSubmitTime"></td>
        <td>
          <input type="text" value="${data.receiverName || ''}" 
                 id="editReceiverName" 
                 readonly 
                 style="background:#1a1a1a; cursor:not-allowed;">
          ${data.receiverName ? '<br><small style="color:#888;">(Cannot edit receiver)</small>' : ''}
        </td>
        <td><input type="text" value="${data.submittedBy}" readonly id="editSubmittedBy"></td>
        <td>
          <select id="editPlantSelect" onchange="handleEditPlantChange(this)">
            <option value="C34A" ${data.plant === 'C34A' ? 'selected' : ''}>C34A</option>
            <option value="C2" ${data.plant === 'C2' ? 'selected' : ''}>C2</option>
            <option value="C3" ${data.plant === 'C3' ? 'selected' : ''}>C3</option>
          </select>
        </td>
        <td id="editStatusCell">
          ${data.receiverStatus === "Pending by Receiver" ? '<span class="status-pending">PENDING</span>' :
            data.receiverStatus === "Received by Security" ? '<span class="status-security">SECURITY</span>' :
            data.receiverStatus === "Received" ? '<span class="status-received">RECEIVED</span>' : '-'}
        </td>
        <td class="action-buttons">
          <button onclick="saveEdit(this, '${id}')" style="background:#00ff00;color:#000">Update</button>
          <button onclick="cancelEdit(this)" style="background:#ff0000;color:#fff">Cancel</button>
        </td>
      `;
      
      // Replace the row
      tbody.replaceChild(editRow, row);
      isEditingMode = true;
      
      // Update receiver field based on plant
      const plantSelect = editRow.querySelector("#editPlantSelect");
      handleEditPlantChange(plantSelect);
      
    } catch (error) {
      console.error('Edit error:', error);
      showAlert('Failed to load record for editing!', 'error');
    }
  }

  function handleEditPlantChange(select) {
    const row = select.closest("tr");
    const receiverInput = row.querySelector("#editReceiverName");
    
    if (select.value === 'C2' || select.value === 'C34A') {
      receiverInput.value = "SECURITY";
    } else if (select.value === 'C3') {
      receiverInput.value = receiverInput.value || "";
      receiverInput.placeholder = "Will be filled after receiving";
    }
  }

  async function saveEdit(btn, id) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");
    
    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: parseFloat(inputs[2].value),
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.trim().toUpperCase(),
      submittedBy: inputs[6].value,
      plant: inputs[7].value.toUpperCase(),
      userDate: currentUserDate // Keep the same user date
    };

    // Validation
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || 
        !data.plant) {
      showAlert('Please fill all fields!', 'error');
      return;
    }

    if (isNaN(data.quantity) || data.quantity <= 0) {
      showAlert('Please enter valid quantity!', 'error');
      return;
    }

    // IMPORTANT: Receiver name cannot be edited for any plant
    // The receiver field is readonly, so this should already be enforced
    
    try {
      const token = localStorage.getItem('token');
      
      const res = await fetch(`/api/wood-bill/${id}`, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Bill updated successfully!', 'success');
        isEditingMode = false;
        loadSavedData();
      } else {
        showAlert(result.message || 'Update failed!', 'error');
      }
    } catch (error) {
      console.error('Update error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  function cancelEdit(btn) {
    isEditingMode = false;
    loadSavedData();
  }

  async function loadViewData() {
    try {
      const res = await fetch("/api/wood-bill");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      allViewData = await res.json();
      
      if (!Array.isArray(allViewData)) {
        console.error("Expected array but got:", allViewData);
        return;
      }

      // Populate filters
      populateFilters(allViewData);
      
      // Apply initial filters
      filterViewData();
      
    } catch (error) {
      console.error("Error loading view data:", error);
      showAlert('Failed to load view data!', 'error');
    }
  }

  function populateFilters(data) {
    const submittedBySet = new Set();
    const receiverSet = new Set();
    
    data.forEach(item => {
      if (item.submittedBy) submittedBySet.add(item.submittedBy);
      if (item.receiverName) receiverSet.add(item.receiverName);
    });
    
    // Populate Submitted By filter
    const submittedByFilter = document.getElementById("submittedByFilter");
    submittedByFilter.innerHTML = '<option value="">ALL USERS</option>';
    submittedBySet.forEach(user => {
      submittedByFilter.innerHTML += `<option value="${user}">${user}</option>`;
    });
    
    // Populate Receiver filter
    const receiverFilter = document.getElementById("receiverFilter");
    receiverFilter.innerHTML = '<option value="">ALL RECEIVERS</option>';
    receiverSet.forEach(receiver => {
      receiverFilter.innerHTML += `<option value="${receiver}">${receiver}</option>`;
    });
  }

  function filterViewData() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const plantFilter = document.getElementById("plantFilter").value;
    const statusFilter = document.getElementById("statusFilter").value;
    const submittedByFilter = document.getElementById("submittedByFilter").value;
    const receiverFilter = document.getElementById("receiverFilter").value;
    const searchText = document.getElementById("searchBox").value.toLowerCase();
    
    filteredViewData = allViewData.filter(item => {
      // Date range filter
      if (startDate || endDate) {
        const itemDate = item.sapDate ? new Date(item.sapDate).toISOString().split('T')[0] : '';
        if (startDate && itemDate < startDate) return false;
        if (endDate && itemDate > endDate) return false;
      }
      
      // Plant filter
      if (plantFilter && item.plant !== plantFilter) return false;
      
      // Status filter
      if (statusFilter && item.receiverStatus !== statusFilter) return false;
      
      // Submitted By filter
      if (submittedByFilter && item.submittedBy !== submittedByFilter) return false;
      
      // Receiver filter
      if (receiverFilter && item.receiverName !== receiverFilter) return false;
      
      // Search filter
      if (searchText) {
        const searchableFields = [
          item.receiverName || '',
          item.submittedBy || '',
          item.plant || '',
          item.quantity?.toString() || '',
          item.sapDate || '',
          item.billDate || ''
        ];
        
        const matches = searchableFields.some(field => 
          field.toLowerCase().includes(searchText)
        );
        
        if (!matches) return false;
      }
      
      return true;
    });
    
    // Update counts
    updateCounts();
    
    // Render filtered data
    renderFilteredData();
  }

  function updateCounts() {
    const total = filteredViewData.length;
    const pending = filteredViewData.filter(item => 
      item.receiverStatus === "Pending by Receiver"
    ).length;
    const received = filteredViewData.filter(item => 
      item.receiverStatus === "Received"
    ).length;
    const security = filteredViewData.filter(item => 
      item.receiverStatus === "Received by Security"
    ).length;
    
    document.getElementById("totalRecords").textContent = total;
    document.getElementById("pendingCount").textContent = pending;
    document.getElementById("receivedCount").textContent = received;
    document.getElementById("securityCount").textContent = security;
  }

  function renderFilteredData() {
    const tbody = document.querySelector("#viewTable tbody");
    tbody.innerHTML = "";
    
    if (filteredViewData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 30px; color: #888;">
            üì≠ No records found matching your filters
          </td>
        </tr>
      `;
      return;
    }
    
    // Sort by date (newest first)
    filteredViewData.sort((a, b) => new Date(b.sapDate) - new Date(a.sapDate));
    
    filteredViewData.forEach((item, index) => {
      const sapDate = item.sapDate ? item.sapDate.split('T')[0] : '';
      const billDate = item.billDate ? item.billDate.split('T')[0] : '';
      
      let statusText = "";
      let statusClass = "";
      
      if (item.receiverStatus === "Pending by Receiver") {
        statusText = "PENDING";
        statusClass = "status-pending";
      } else if (item.receiverStatus === "Received by Security") {
        statusText = "SECURITY";
        statusClass = "status-security";
      } else if (item.receiverStatus === "Received") {
        statusText = "RECEIVED";
        statusClass = "status-received";
      }
      
      tbody.innerHTML += `
        <tr class="${item.receiverStatus === "Pending by Receiver" ? 'pending-row' : ''}">
          <td>${index + 1}</td>
          <td>${sapDate}</td>
          <td>${billDate}</td>
          <td>${item.quantity}</td>
          <td>${item.submitTime}</td>
          <td>${item.receiverName || (item.plant === 'C3' ? 'PENDING...' : '-')}</td>
          <td>${item.submittedBy}</td>
          <td>${item.plant}</td>
          <td class="${statusClass}">${statusText}</td>
        </tr>
      `;
    });
  }

  function clearFilters() {
    // Reset date range to last 30 days
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    document.getElementById('plantFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('submittedByFilter').value = '';
    document.getElementById('receiverFilter').value = '';
    document.getElementById('searchBox').value = '';
    
    filterViewData();
    showAlert('Filters cleared successfully!', 'success');
  }

  function exportToExcel() {
    if (filteredViewData.length === 0) {
      showAlert('No data to export!', 'warning');
      return;
    }
    
    // Create CSV content
    let csvContent = "S.No,SAP Date,Bill Date,Quantity,Submit Time,Receiver Name,Submitted By,Plant,Status\n";
    
    filteredViewData.forEach((item, index) => {
      const sapDate = item.sapDate ? item.sapDate.split('T')[0] : '';
      const billDate = item.billDate ? item.billDate.split('T')[0] : '';
      const status = item.receiverStatus === "Pending by Receiver" ? "PENDING" :
                    item.receiverStatus === "Received by Security" ? "SECURITY" : "RECEIVED";
      
      csvContent += `${index + 1},${sapDate},${billDate},${item.quantity},${item.submitTime},${item.receiverName || ''},${item.submittedBy},${item.plant},${status}\n`;
    });
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Wood_Bills_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert('Exported to CSV successfully!', 'success');
  }

  function printReport() {
    window.print();
  }

  async function deleteRow(btn, id) {
    if (!confirm('Are you sure you want to delete this bill?')) {
      return;
    }

    try {
      // First check if user can delete this record
      const checkRes = await fetch(`/api/wood-bill/${id}`);
      const checkData = await checkRes.json();
      
      if (checkData.submittedBy !== currentUser || checkData.userDate !== currentUserDate) {
        showAlert('You can only delete records created by you on the same date!', 'error');
        return;
      }

      if (checkData.receiverStatus === "Received") {
        showAlert('Cannot delete received bills!', 'error');
        return;
      }

      const res = await fetch(`/api/wood-bill/${id}`, {
        method: "DELETE",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem('token')}`
        }
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Bill deleted successfully!', 'success');
        loadSavedData();
        loadViewData(); // Also refresh view data
      } else {
        showAlert(result.message || 'Delete failed!', 'error');
      }
    } catch (error) {
      console.error('Delete error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  // Auto-refresh every 30 seconds
  setInterval(() => {
    if (!isEditingMode) {
      if (document.getElementById("fillTableSection").style.display !== "none") {
        loadSavedData();
      }
      if (document.getElementById("viewSection").style.display !== "none") {
        loadViewData();
      }
    }
  }, 30000);
</script>

</body>
</html>
