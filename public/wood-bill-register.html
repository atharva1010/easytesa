<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WOOD BILL SUBMIT REGISTER</title>
  <style>
    * {
      text-transform: uppercase;
      box-sizing: border-box;
    }
    body {
      background-color: #0f2027;
      color: #00ffe7;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 5px #00ffe7;
      margin-top: 0;
    }
    button {
      padding: 8px 16px;
      margin: 10px 5px;
      border: 1px solid #00ffe7;
      background: transparent;
      color: #00ffe7;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      box-shadow: 0 0 10px #00ffe7;
    }
    th, td {
      padding: 10px;
      border: 1px solid #00ffe7;
      text-align: center;
    }
    input, select {
      width: 100%;
      background: #111;
      color: #00ffe7;
      border: 1px solid #00ffe7;
      padding: 8px;
      border-radius: 4px;
    }
    #filters {
      display: none;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #filters input, #filters select {
      width: auto;
      margin: 0;
    }
    .readonly input, .readonly select {
      pointer-events: none;
      background: #1c1c1c;
    }
    
    /* Mobile Styles */
    @media only screen and (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      #fillTableSection table, 
      #viewSection table {
        display: none;
      }
      
      /* Mobile Form Styles */
      .mobile-form {
        display: block;
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        border: 1px solid #00ffe7;
        border-radius: 8px;
        box-shadow: 0 0 10px #00ffe7;
      }
      
      .mobile-form .form-group {
        margin-bottom: 15px;
      }
      
      .mobile-form label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
      }
      
      .mobile-form input, 
      .mobile-form select {
        width: 100%;
        padding: 12px; /* Increased padding for better touch */
        font-size: 16px;
        -webkit-appearance: none; /* Fix for iOS */
      }
      
      /* Specific fix for number input */
      .mobile-form input[type="number"] {
        -moz-appearance: textfield; /* Firefox */
      }
      
      .mobile-form .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }
      
      .mobile-form .form-actions button {
        flex: 1;
        margin: 0 5px;
        padding: 12px;
        font-size: 16px;
      }
      
      /* Mobile View Styles */
      .mobile-view-item {
        border: 1px solid #00ffe7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 0 5px #00ffe7;
      }
      
      .mobile-view-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .mobile-view-label {
        font-weight: bold;
        color: #00b3a1;
      }
      
      /* Show mobile elements only on mobile */
      .mobile-only {
        display: none;
      }
      
      @media only screen and (max-width: 768px) {
        .mobile-only {
          display: block;
        }
        .desktop-only {
          display: none;
        }
      }
    }
  </style>
</head>
<body onload="initPage()">

  <h2>WOOD BILL SUBMIT REGISTER</h2>

  <button onclick="showFill()">FILL REPORT</button>
  <button id="addRowBtn" onclick="addRow()">ADD ROW</button>
  <button onclick="showView()">VIEW REPORT</button>

  <!-- Filters -->
  <div id="filters" class="desktop-only">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="receiverFilter">
      <option value="">Filter Receiver</option>
    </select>
    <select id="submittedByFilter">
      <option value="">Filter Submitted By</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search...">
    <button onclick="filterView()">Search</button>
  </div>

  <!-- Fill Table (Desktop) -->
  <div id="fillTableSection" class="desktop-only">
    <table id="fillTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <!-- Mobile Form (Hidden on desktop) -->
  <div id="mobileFillForm" class="mobile-only" style="display: none;">
    <form id="mobileDataForm" class="mobile-form" onsubmit="saveMobileForm(event)">
      <div class="form-group">
        <label for="mobileSapDate">SAP DATE</label>
        <input type="date" id="mobileSapDate" required>
      </div>
      <div class="form-group">
        <label for="mobileBillDate">BILL SUBMIT DATE</label>
        <input type="date" id="mobileBillDate" required>
      </div>
      <div class="form-group">
        <label for="mobileQuantity">QUANTITY</label>
        <input type="number" id="mobileQuantity" min="1" required 
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
      </div>
      <div class="form-group">
        <label for="mobileSubmitTime">SUBMIT TIME</label>
        <input type="time" id="mobileSubmitTime" required>
      </div>
      <div class="form-group">
        <label for="mobileReceiverName">RECEIVER NAME</label>
        <input type="text" id="mobileReceiverName" required
               oninput="this.value = this.value.toUpperCase()">
      </div>
      <div class="form-group">
        <label for="mobileSubmittedBy">SUBMITTED BY</label>
        <input type="text" id="mobileSubmittedBy" value="${currentUser}" disabled>
      </div>
      <div class="form-group">
        <label for="mobilePlant">PLANT</label>
        <select id="mobilePlant" required>
          <option value="">Select</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="button" onclick="cancelMobileForm()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
  
  <!-- Mobile View (Hidden on desktop) -->
  <div id="mobileViewSection" class="mobile-only" style="display: none;">
    <!-- Mobile filters -->
    <div style="margin: 15px 0;">
      <input type="date" id="mobileStartDate" style="width: 48%;">
      <input type="date" id="mobileEndDate" style="width: 48%; float: right;">
      <select id="mobileReceiverFilter" style="width: 100%; margin-top: 10px;">
        <option value="">Filter Receiver</option>
      </select>
      <select id="mobileSubmittedByFilter" style="width: 100%; margin-top: 10px;">
        <option value="">Filter Submitted By</option>
      </select>
      <input type="text" id="mobileSearchBox" placeholder="Search..." style="width: 100%; margin-top: 10px;">
      <button onclick="filterMobileView()" style="width: 100%; margin-top: 10px;">Search</button>
    </div>
    
    <!-- Mobile view items will be inserted here -->
    <div id="mobileViewItems"></div>
  </div>

  <!-- View Table (Desktop) -->
  <div id="viewSection" class="desktop-only" style="display: none;">
    <table id="viewTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = (localStorage.getItem("username") || "unknown").toUpperCase();
  let unsavedRowExists = false;
  let isMobile = window.innerWidth <= 768;
  let editingId = null;

  // Detect screen size changes
  window.addEventListener('resize', function() {
    isMobile = window.innerWidth <= 768;
    if (isMobile) {
      // Refresh the view when switching to mobile
      if (document.getElementById("fillTableSection").style.display !== "none") {
        showFill();
      } else if (document.getElementById("viewSection").style.display !== "none") {
        showView();
      }
    } else {
      // Refresh the view when switching to desktop
      if (document.getElementById("mobileFillForm").style.display !== "none") {
        showFill();
      } else if (document.getElementById("mobileViewSection").style.display !== "none") {
        showView();
      }
    }
  });

  document.addEventListener("DOMContentLoaded", initPage);

  function initPage() {
    showFill();
    loadSavedData();
    
    // Desktop event listeners
    document.getElementById("searchBox").addEventListener("input", filterView);
    document.getElementById("startDate").addEventListener("change", filterView);
    document.getElementById("endDate").addEventListener("change", filterView);
    document.getElementById("receiverFilter").addEventListener("change", filterView);
    document.getElementById("submittedByFilter").addEventListener("change", filterView);
    
    // Mobile event listeners
    document.getElementById("mobileSearchBox").addEventListener("input", filterMobileView);
    document.getElementById("mobileStartDate").addEventListener("change", filterMobileView);
    document.getElementById("mobileEndDate").addEventListener("change", filterMobileView);
    document.getElementById("mobileReceiverFilter").addEventListener("change", filterMobileView);
    document.getElementById("mobileSubmittedByFilter").addEventListener("change", filterMobileView);
  }

  function showFill() {
    if (isMobile) {
      // Mobile view
      document.getElementById("mobileFillForm").style.display = "none";
      document.getElementById("mobileViewSection").style.display = "none";
      document.getElementById("addRowBtn").style.display = "inline-block";
      
      // Clear any existing form
      document.getElementById("mobileSapDate").value = "";
      document.getElementById("mobileBillDate").value = "";
      document.getElementById("mobileQuantity").value = "";
      document.getElementById("mobileSubmitTime").value = "";
      document.getElementById("mobileReceiverName").value = "";
      document.getElementById("mobilePlant").value = "";
      document.getElementById("mobileSubmittedBy").value = currentUser;
      editingId = null;
    } else {
      // Desktop view
      document.getElementById("fillTableSection").style.display = "block";
      document.getElementById("viewSection").style.display = "none";
      document.getElementById("filters").style.display = "none";
      document.getElementById("addRowBtn").style.display = "inline-block";
    }
  }

  function showView() {
    if (isMobile) {
      // Mobile view
      document.getElementById("mobileFillForm").style.display = "none";
      document.getElementById("mobileViewSection").style.display = "block";
      document.getElementById("addRowBtn").style.display = "none";
      loadMobileViewData();
    } else {
      // Desktop view
      document.getElementById("fillTableSection").style.display = "none";
      document.getElementById("viewSection").style.display = "block";
      document.getElementById("filters").style.display = "block";
      document.getElementById("addRowBtn").style.display = "none";
      loadViewData();
    }
  }

  function addRow() {
    if (isMobile) {
      // Show mobile form
      document.getElementById("mobileFillForm").style.display = "block";
      unsavedRowExists = true;
      // Scroll to form for better UX
      document.getElementById("mobileFillForm").scrollIntoView({ behavior: 'smooth' });
    } else {
      // Desktop add row
      if (unsavedRowExists) {
        alert("Please save the current row before adding a new one.");
        return;
      }

      const tbody = document.querySelector("#fillTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="status">üìù</td>
        <td><input type="date"></td>
        <td><input type="date"></td>
        <td><input type="number" min="1"></td>
        <td><input type="time"></td>
        <td><input type="text"></td>
        <td><input type="text" value="${currentUser}" disabled></td>
        <td>
          <select>
            <option value="">Select</option>
            <option value="C34A">C34A</option>
            <option value="C2">C2</option>
            <option value="C3">C3</option>
          </select>
        </td>
        <td><button onclick="saveRow(this)">Save</button></td>
      `;
      tbody.prepend(row);
      unsavedRowExists = true;
    }
  }
  
  function cancelMobileForm() {
    document.getElementById("mobileFillForm").style.display = "none";
    unsavedRowExists = false;
    editingId = null;
  }
  
  async function saveMobileForm(event) {
    // Prevent default form submission
    if (event) event.preventDefault();
    
    const form = document.getElementById("mobileDataForm");
    const data = {
      sapDate: form.mobileSapDate.value,
      billDate: form.mobileBillDate.value,
      quantity: form.mobileQuantity.value,
      submitTime: form.mobileSubmitTime.value,
      receiverName: form.mobileReceiverName.value.toUpperCase(),
      submittedBy: currentUser,
      plant: form.mobilePlant.value.toUpperCase()
    };

    // Validate form (though HTML5 validation should handle this)
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || !data.receiverName || !data.plant) {
      alert("Please fill all fields.");
      return;
    }

    const endpoint = editingId ? `/api/wood-bill/${editingId}` : "/api/wood-bill";
    const method = editingId ? "PUT" : "POST";

    try {
      const res = await fetch(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        alert("Data saved successfully!");
        document.getElementById("mobileFillForm").style.display = "none";
        unsavedRowExists = false;
        editingId = null;
        loadSavedData();
      } else {
        alert("Save failed: " + (result.message || ""));
      }
    } catch (error) {
      alert("Error saving data: " + error.message);
    }
  }

  async function saveRow(btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");

    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: inputs[2].value,
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase()
    };

    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || !data.receiverName || !data.plant) {
      alert("Please fill all fields.");
      return;
    }

    const res = await fetch("/api/wood-bill", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (result.success) {
      row.innerHTML = `
        <td class="status">‚úÖ</td>
        <td>${data.sapDate}</td>
        <td>${data.billDate}</td>
        <td>${data.quantity}</td>
        <td>${data.submitTime}</td>
        <td>${data.receiverName}</td>
        <td>${data.submittedBy}</td>
        <td>${data.plant}</td>
        <td><button onclick="editRow(this)" data-id="${result.id}">Edit</button></td>
      `;
      unsavedRowExists = false;
    } else {
      alert("Save failed.");
    }
  }

  async function loadSavedData() {
    try {
      const res = await fetch("/api/wood-bill");
      const rows = await res.json();
      
      if (isMobile) {
        // For mobile, we don't show the table in fill mode
        return;
      }
      
      // Desktop table
      const tbody = document.querySelector("#fillTable tbody");
      tbody.innerHTML = "";

      rows.forEach((d) => {
        tbody.innerHTML += `
          <tr>
            <td class="status">‚úÖ</td>
            <td>${d.sapDate}</td>
            <td>${d.billDate}</td>
            <td>${d.quantity}</td>
            <td>${d.submitTime}</td>
            <td>${d.receiverName}</td>
            <td>${d.submittedBy}</td>
            <td>${d.plant}</td>
            <td>
              ${d.submittedBy === currentUser
                ? `<button onclick="editRow(this)" data-id="${d._id}">Edit</button>`
                : `<span style="color:gray;">Locked</span>`}
            </td>
          </tr>
        `;
      });
    } catch (error) {
      console.error("Error loading data:", error);
    }
  }
  
  async function loadMobileViewData() {
    try {
      const res = await fetch("/api/wood-bill");
      const rows = await res.json();
      
      const receivers = new Set();
      const submitters = new Set();
      const viewItems = document.getElementById("mobileViewItems");
      viewItems.innerHTML = "";
      
      // Populate filters
      const receiverFilter = document.getElementById("mobileReceiverFilter");
      const submittedByFilter = document.getElementById("mobileSubmittedByFilter");
      
      receiverFilter.innerHTML = `<option value="">Receiver</option>`;
      submittedByFilter.innerHTML = `<option value="">Submitted By</option>`;
      
      rows.forEach((d, i) => {
        if (d.receiverName) receivers.add(d.receiverName);
        if (d.submittedBy) submitters.add(d.submittedBy);
        
        viewItems.innerHTML += `
          <div class="mobile-view-item">
            <div class="mobile-view-row">
              <span class="mobile-view-label">S.NO:</span>
              <span>${i + 1}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SAP DATE:</span>
              <span>${d.sapDate}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">BILL DATE:</span>
              <span>${d.billDate}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">QUANTITY:</span>
              <span>${d.quantity}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SUBMIT TIME:</span>
              <span>${d.submitTime}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">RECEIVER:</span>
              <span>${d.receiverName}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SUBMITTED BY:</span>
              <span>${d.submittedBy}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">PLANT:</span>
              <span>${d.plant}</span>
            </div>
            ${d.submittedBy === currentUser ? `
            <div style="margin-top: 10px; text-align: right;">
              <button onclick="editMobileItem('${d._id}')" style="padding: 5px 10px; font-size: 12px;">Edit</button>
            </div>
            ` : ''}
          </div>
        `;
      });
      
      // Add options to filters
      receivers.forEach(r => {
        receiverFilter.innerHTML += `<option value="${r}">${r}</option>`;
      });
      
      submitters.forEach(s => {
        submittedByFilter.innerHTML += `<option value="${s}">${s}</option>`;
      });
      
    } catch (error) {
      console.error("Error loading mobile view data:", error);
    }
  }
  
  function editMobileItem(id) {
    // Find the item in the data
    fetch(`/api/wood-bill/${id}`)
      .then(res => res.json())
      .then(data => {
        if (data) {
          // Populate the mobile form
          document.getElementById("mobileSapDate").value = data.sapDate || "";
          document.getElementById("mobileBillDate").value = data.billDate || "";
          document.getElementById("mobileQuantity").value = data.quantity || "";
          document.getElementById("mobileSubmitTime").value = data.submitTime || "";
          document.getElementById("mobileReceiverName").value = data.receiverName || "";
          document.getElementById("mobilePlant").value = data.plant || "";
          document.getElementById("mobileSubmittedBy").value = data.submittedBy || currentUser;
          
          // Set editing mode
          editingId = id;
          unsavedRowExists = true;
          
          // Show the form
          document.getElementById("mobileFillForm").style.display = "block";
          
          // Scroll to form
          document.getElementById("mobileFillForm").scrollIntoView({ behavior: 'smooth' });
        }
      })
      .catch(error => {
        console.error("Error fetching item for edit:", error);
        alert("Error loading data for editing");
      });
  }

  function editRow(btn) {
    if (isMobile) {
      editMobileItem(btn.dataset.id);
      return;
    }
    
    const row = btn.closest("tr");
    const submittedBy = row.children[6].textContent;
    const id = btn.dataset.id;

    if (submittedBy !== currentUser) {
      alert("You can only edit your own rows.");
      return;
    }

    const data = {
      sapDate: row.children[1].textContent,
      billDate: row.children[2].textContent,
      quantity: row.children[3].textContent,
      submitTime: row.children[4].textContent,
      receiverName: row.children[5].textContent,
      plant: row.children[7].textContent,
    };

    row.innerHTML = `
      <td class="status">üìù</td>
      <td><input type="date" value="${data.sapDate}"></td>
      <td><input type="date" value="${data.billDate}"></td>
      <td><input type="number" value="${data.quantity}"></td>
      <td><input type="time" value="${data.submitTime}"></td>
      <td><input type="text" value="${data.receiverName}"></td>
      <td><input type="text" value="${currentUser}" disabled></td>
      <td>
        <select>
          <option ${data.plant === "C34A" ? "selected" : ""}>C34A</option>
          <option ${data.plant === "C2" ? "selected" : ""}>C2</option>
          <option ${data.plant === "C3" ? "selected" : ""}>C3</option>
        </select>
      </td>
      <td><button onclick="updateRow(this, '${id}')">Update</button></td>
    `;
  }

  async function updateRow(btn, id) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");

    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: inputs[2].value,
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase()
    };

    const res = await fetch(`/api/wood-bill/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (result.success) {
      loadSavedData();
    } else {
      alert("Update failed");
    }
  }

  async function loadViewData() {
    const res = await fetch("/api/wood-bill");
    const rows = await res.json();
    const tbody = document.querySelector("#viewTable tbody");
    tbody.innerHTML = "";

    const receivers = new Set();
    const submitters = new Set();

    rows.forEach((d, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${d.sapDate}</td>
          <td>${d.billDate}</td>
          <td>${d.quantity}</td>
          <td>${d.submitTime}</td>
          <td>${d.receiverName}</td>
          <td>${d.submittedBy}</td>
          <td>${d.plant}</td>
        </tr>
      `;
      if (d.receiverName) receivers.add(d.receiverName);
      if (d.submittedBy) submitters.add(d.submittedBy);
    });

    document.getElementById("receiverFilter").innerHTML =
      `<option value="">Receiver</option>` +
      [...receivers].map(r => `<option value="${r}">${r}</option>`).join("");

    document.getElementById("submittedByFilter").innerHTML =
      `<option value="">Submitted By</option>` +
      [...submitters].map(s => `<option value="${s}">${s}</option>`).join("");
  }
  
  async function filterMobileView() {
    const startDate = document.getElementById("mobileStartDate").value;
    const endDate = document.getElementById("mobileEndDate").value;
    const receiver = document.getElementById("mobileReceiverFilter").value.toLowerCase();
    const submittedBy = document.getElementById("mobileSubmittedByFilter").value.toLowerCase();
    const searchText = document.getElementById("mobileSearchBox").value.toLowerCase();

    try {
      const res = await fetch("/api/wood-bill");
      const data = await res.json();
      
      const filtered = data.filter(d => {
        const inDateRange =
          (!startDate || new Date(d.sapDate) >= new Date(startDate)) &&
          (!endDate || new Date(d.sapDate) <= new Date(endDate));
        const matchesReceiver = !receiver || d.receiverName?.toLowerCase().includes(receiver);
        const matchesSubmitter = !submittedBy || d.submittedBy?.toLowerCase().includes(submittedBy);
        const matchesSearch = !searchText || Object.values(d).some(val => String(val).toLowerCase().includes(searchText));
        return inDateRange && matchesReceiver && matchesSubmitter && matchesSearch;
      });

      const viewItems = document.getElementById("mobileViewItems");
      viewItems.innerHTML = "";
      
      filtered.forEach((d, i) => {
        viewItems.innerHTML += `
          <div class="mobile-view-item">
            <div class="mobile-view-row">
              <span class="mobile-view-label">S.NO:</span>
              <span>${i + 1}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SAP DATE:</span>
              <span>${d.sapDate}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">BILL DATE:</span>
              <span>${d.billDate}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">QUANTITY:</span>
              <span>${d.quantity}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SUBMIT TIME:</span>
              <span>${d.submitTime}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">RECEIVER:</span>
              <span>${d.receiverName}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">SUBMITTED BY:</span>
              <span>${d.submittedBy}</span>
            </div>
            <div class="mobile-view-row">
              <span class="mobile-view-label">PLANT:</span>
              <span>${d.plant}</span>
            </div>
            ${d.submittedBy === currentUser ? `
            <div style="margin-top: 10px; text-align: right;">
              <button onclick="editMobileItem('${d._id}')" style="padding: 5px 10px; font-size: 12px;">Edit</button>
            </div>
            ` : ''}
          </div>
        `;
      });
    } catch (error) {
      console.error("Error filtering mobile view:", error);
    }
  }

  function filterView() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const receiver = document.getElementById("receiverFilter").value.toLowerCase();
    const submittedBy = document.getElementById("submittedByFilter").value.toLowerCase();
    const searchText = document.getElementById("searchBox").value.toLowerCase();

    fetch("/api/wood-bill")
      .then(res => res.json())
      .then(data => {
        const filtered = data.filter(d => {
          const inDateRange =
            (!startDate || new Date(d.sapDate) >= new Date(startDate)) &&
            (!endDate || new Date(d.sapDate) <= new Date(endDate));
          const matchesReceiver = !receiver || d.receiverName?.toLowerCase().includes(receiver);
          const matchesSubmitter = !submittedBy || d.submittedBy?.toLowerCase().includes(submittedBy);
          const matchesSearch = !searchText || Object.values(d).some(val => String(val).toLowerCase().includes(searchText));
          return inDateRange && matchesReceiver && matchesSubmitter && matchesSearch;
        });

        const tbody = document.querySelector("#viewTable tbody");
        tbody.innerHTML = "";
        filtered.forEach((d, i) => {
          tbody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>${d.sapDate}</td>
              <td>${d.billDate}</td>
              <td>${d.quantity}</td>
              <td>${d.submitTime}</td>
              <td>${d.receiverName}</td>
              <td>${d.submittedBy}</td>
              <td>${d.plant}</td>
            </tr>
          `;
        });
      });
  }
</script>
</body>
</html>
