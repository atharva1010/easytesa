<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WOOD BILL SUBMIT REGISTER</title>
  <style>
    * {
      text-transform: uppercase;
      box-sizing: border-box;
    }
    body {
      background-color: #0f2027;
      color: #00ffe7;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 5px #00ffe7;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 16px;
      margin: 10px 5px;
      border: 1px solid #00ffe7;
      background: transparent;
      color: #00ffe7;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      background: #00ffe7;
      color: #0f2027;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #666;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      box-shadow: 0 0 10px #00ffe7;
    }
    th, td {
      padding: 10px;
      border: 1px solid #00ffe7;
      text-align: center;
    }
    th {
      background: rgba(0, 255, 231, 0.1);
    }
    input, select {
      width: 100%;
      background: #111;
      color: #00ffe7;
      border: 1px solid #00ffe7;
      padding: 8px;
      border-radius: 4px;
    }
    input:focus, select:focus {
      outline: 1px solid #00ffe7;
      box-shadow: 0 0 5px #00ffe7;
    }
    input:read-only, input:disabled {
      background: #1a1a1a;
      cursor: not-allowed;
    }
    #filters {
      display: none;
      margin-top: 10px;
      background: rgba(0, 255, 231, 0.05);
      padding: 15px;
      border-radius: 5px;
    }
    #filters input, #filters select {
      width: auto;
      margin: 5px;
      min-width: 150px;
    }
    .status-cell {
      font-size: 18px;
      text-align: center;
    }
    .editing {
      background: rgba(0, 255, 231, 0.1);
    }
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .action-buttons button {
      padding: 5px 10px;
      margin: 0;
      font-size: 12px;
      min-width: 60px;
    }
    .action-buttons button.save-btn {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00ff00;
    }
    .action-buttons button.edit-btn {
      background: rgba(255, 255, 0, 0.1);
      border-color: #ffff00;
    }
    .action-buttons button.delete-btn {
      background: rgba(255, 0, 0, 0.1);
      border-color: #ff0000;
    }
    .action-buttons button.cancel-btn {
      background: rgba(128, 128, 128, 0.1);
      border-color: #888;
    }
    .today-row {
      background: rgba(0, 255, 231, 0.05);
    }
    .locked-row {
      opacity: 0.7;
    }
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.3s;
    }
    .success {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
    }
    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #ff0000;
      color: #ff0000;
    }
    .warning {
      background: rgba(255, 255, 0, 0.2);
      border: 1px solid #ffff00;
      color: #ffff00;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body onload="initPage()">

  <h2>WOOD BILL SUBMIT REGISTER</h2>

  <button onclick="showFill()">FILL REPORT</button>
  <button id="addRowBtn" onclick="addNewRow()">ADD NEW ROW</button>
  <button onclick="showView()">VIEW REPORT</button>

  <!-- Filters -->
  <div id="filters">
    <input type="date" id="startDate" onchange="filterView()">
    <input type="date" id="endDate" onchange="filterView()">
    <select id="receiverFilter" onchange="filterView()">
      <option value="">All Receivers</option>
    </select>
    <select id="submittedByFilter" onchange="filterView()">
      <option value="">All Submitters</option>
    </select>
    <select id="plantFilter" onchange="filterView()">
      <option value="">All Plants</option>
      <option value="C34A">C34A</option>
      <option value="C2">C2</option>
      <option value="C3">C3</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search..." oninput="filterView()">
    <button onclick="clearFilters()">Clear Filters</button>
  </div>

  <!-- Fill Table -->
  <div id="fillTableSection">
    <table id="fillTable">
      <thead>
        <tr>
          <th width="50">S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
          <th width="200">ACTIONS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- View Table -->
  <div id="viewSection" style="display: none;">
    <table id="viewTable">
      <thead>
        <tr>
          <th>S.NO</th>
          <th>SAP DATE</th>
          <th>BILL SUBMIT DATE</th>
          <th>QUANTITY</th>
          <th>SUBMIT TIME</th>
          <th>RECEIVER NAME</th>
          <th>SUBMITTED BY</th>
          <th>PLANT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = (localStorage.getItem("username") || "unknown").toUpperCase();
  let isEditingMode = false;
  let today = new Date().toISOString().split('T')[0];
  let allData = [];

  function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }

  function initPage() {
    loadSavedData();
    showFill();
    
    // Set today's date in date filters
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
  }

  function showFill() {
    document.getElementById("fillTableSection").style.display = "block";
    document.getElementById("viewSection").style.display = "none";
    document.getElementById("filters").style.display = "none";
    document.getElementById("addRowBtn").style.display = "inline-block";
  }

  function showView() {
    document.getElementById("fillTableSection").style.display = "none";
    document.getElementById("viewSection").style.display = "block";
    document.getElementById("filters").style.display = "block";
    document.getElementById("addRowBtn").style.display = "none";
    loadViewData();
  }

  function addNewRow() {
    if (isEditingMode) {
      showAlert('Please save or cancel the current edit first!', 'warning');
      return;
    }

    const tbody = document.querySelector("#fillTable tbody");
    const row = document.createElement("tr");
    row.className = "today-row";
    row.innerHTML = `
      <td class="status-cell">üìù</td>
      <td><input type="date" value="${today}"></td>
      <td><input type="date" value="${today}"></td>
      <td><input type="number" min="1" placeholder="Quantity"></td>
      <td><input type="time" value="${new Date().toTimeString().slice(0,5)}"></td>
      <td><input type="text" placeholder="Receiver Name"></td>
      <td><input type="text" value="${currentUser}" readonly></td>
      <td>
        <select>
          <option value="">Select Plant</option>
          <option value="C34A">C34A</option>
          <option value="C2">C2</option>
          <option value="C3">C3</option>
        </select>
      </td>
      <td class="action-buttons">
        <button class="save-btn" onclick="saveRow(this)">Save</button>
        <button class="cancel-btn" onclick="cancelAdd(this)">Cancel</button>
      </td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
    isEditingMode = true;
    row.querySelector('input').focus();
  }

  async function saveRow(btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");
    
    // Get current date to check if editing is allowed
    const currentDate = new Date();
    const sapDate = new Date(inputs[0].value);
    const billDate = new Date(inputs[1].value);
    
    // Check if dates are today
    const isSapDateToday = sapDate.toDateString() === currentDate.toDateString();
    const isBillDateToday = billDate.toDateString() === currentDate.toDateString();
    
    if (!isSapDateToday || !isBillDateToday) {
      showAlert('You can only add entries for today\'s date!', 'error');
      return;
    }

    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: parseFloat(inputs[2].value),
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.trim().toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase()
    };

    // Validation
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || 
        !data.receiverName || !data.plant) {
      showAlert('Please fill all fields!', 'error');
      return;
    }

    if (isNaN(data.quantity) || data.quantity <= 0) {
      showAlert('Please enter valid quantity!', 'error');
      return;
    }

    try {
      const res = await fetch("/api/wood-bill", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Row saved successfully!', 'success');
        row.innerHTML = `
          <td class="status-cell">‚úÖ</td>
          <td>${data.sapDate}</td>
          <td>${data.billDate}</td>
          <td>${data.quantity}</td>
          <td>${data.submitTime}</td>
          <td>${data.receiverName}</td>
          <td>${data.submittedBy}</td>
          <td>${data.plant}</td>
          <td class="action-buttons">
            <button class="edit-btn" onclick="editRow(this, '${result.id || result._id}')">Edit</button>
            <button class="delete-btn" onclick="deleteRow(this, '${result.id || result._id}')">Delete</button>
          </td>
        `;
        isEditingMode = false;
        loadSavedData(); // Refresh the data
      } else {
        showAlert(result.message || 'Save failed!', 'error');
      }
    } catch (error) {
      console.error('Save error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  function cancelAdd(btn) {
    const row = btn.closest("tr");
    row.remove();
    isEditingMode = false;
  }

  async function loadSavedData() {
    try {
      const res = await fetch("/api/wood-bill");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      allData = await res.json();
      const tbody = document.querySelector("#fillTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(allData)) {
        console.error("Expected array but got:", allData);
        return;
      }

      // Sort by date (newest first)
      allData.sort((a, b) => new Date(b.sapDate) - new Date(a.sapDate));

      allData.forEach((d, index) => {
        const sapDate = d.sapDate ? d.sapDate.split('T')[0] : '';
        const billDate = d.billDate ? d.billDate.split('T')[0] : '';
        const currentDate = new Date().toDateString();
        const rowDate = new Date(sapDate).toDateString();
        
        // Check if this entry can be edited (only if same user and same date)
        const canEdit = d.submittedBy === currentUser && rowDate === currentDate;
        
        const rowClass = rowDate === currentDate ? 'today-row' : 'locked-row';
        
        tbody.innerHTML += `
          <tr class="${rowClass}">
            <td class="status-cell">${index + 1}</td>
            <td>${sapDate}</td>
            <td>${billDate}</td>
            <td>${d.quantity}</td>
            <td>${d.submitTime}</td>
            <td>${d.receiverName}</td>
            <td>${d.submittedBy}</td>
            <td>${d.plant}</td>
            <td class="action-buttons">
              ${canEdit ? 
                `<button class="edit-btn" onclick="editRow(this, '${d._id}')">Edit</button>
                 <button class="delete-btn" onclick="deleteRow(this, '${d._id}')">Delete</button>` :
                `<span style="color:gray; font-size:12px;">Locked</span>`
              }
            </td>
          </tr>
        `;
      });
    } catch (error) {
      console.error("Error loading data:", error);
      showAlert('Failed to load data!', 'error');
    }
  }

  function editRow(btn, id) {
    if (isEditingMode) {
      showAlert('Please finish current edit first!', 'warning');
      return;
    }

    const row = btn.closest("tr");
    const cells = row.querySelectorAll("td");
    
    // Get current values
    const data = {
      sapDate: cells[1].textContent,
      billDate: cells[2].textContent,
      quantity: cells[3].textContent,
      submitTime: cells[4].textContent,
      receiverName: cells[5].textContent,
      plant: cells[7].textContent
    };

    // Check if date is today
    const currentDate = new Date().toDateString();
    const rowDate = new Date(data.sapDate).toDateString();
    
    if (rowDate !== currentDate) {
      showAlert('You can only edit today\'s entries!', 'error');
      return;
    }

    isEditingMode = true;
    
    row.innerHTML = `
      <td class="status-cell">üìù</td>
      <td><input type="date" value="${data.sapDate}" readonly></td>
      <td><input type="date" value="${data.billDate}" readonly></td>
      <td><input type="number" value="${data.quantity}" min="1"></td>
      <td><input type="time" value="${data.submitTime}"></td>
      <td><input type="text" value="${data.receiverName}"></td>
      <td><input type="text" value="${currentUser}" readonly></td>
      <td>
        <select>
          <option value="C34A" ${data.plant === 'C34A' ? 'selected' : ''}>C34A</option>
          <option value="C2" ${data.plant === 'C2' ? 'selected' : ''}>C2</option>
          <option value="C3" ${data.plant === 'C3' ? 'selected' : ''}>C3</option>
        </select>
      </td>
      <td class="action-buttons">
        <button class="save-btn" onclick="updateRow(this, '${id}')">Update</button>
        <button class="cancel-btn" onclick="cancelEdit(this, '${id}')">Cancel</button>
      </td>
    `;
    
    row.classList.add('editing');
    row.querySelector('input').focus();
  }

  function cancelEdit(btn, id) {
    loadSavedData();
    isEditingMode = false;
  }

  async function updateRow(btn, id) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input, select");

    const data = {
      sapDate: inputs[0].value,
      billDate: inputs[1].value,
      quantity: parseFloat(inputs[2].value),
      submitTime: inputs[3].value,
      receiverName: inputs[4].value.trim().toUpperCase(),
      submittedBy: currentUser,
      plant: inputs[6].value.toUpperCase()
    };

    // Validation
    if (!data.sapDate || !data.billDate || !data.quantity || !data.submitTime || 
        !data.receiverName || !data.plant) {
      showAlert('Please fill all fields!', 'error');
      return;
    }

    if (isNaN(data.quantity) || data.quantity <= 0) {
      showAlert('Please enter valid quantity!', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/wood-bill/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Row updated successfully!', 'success');
        isEditingMode = false;
        loadSavedData();
      } else {
        showAlert(result.message || 'Update failed!', 'error');
      }
    } catch (error) {
      console.error('Update error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  async function deleteRow(btn, id) {
    if (!confirm('Are you sure you want to delete this row?')) {
      return;
    }

    const row = btn.closest("tr");
    const sapDate = row.children[1].textContent;
    const currentDate = new Date().toDateString();
    const rowDate = new Date(sapDate).toDateString();
    
    if (rowDate !== currentDate) {
      showAlert('You can only delete today\'s entries!', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/wood-bill/${id}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();
      
      if (result.success) {
        showAlert('Row deleted successfully!', 'success');
        row.remove();
        loadSavedData(); // Refresh data
      } else {
        showAlert(result.message || 'Delete failed!', 'error');
      }
    } catch (error) {
      console.error('Delete error:', error);
      showAlert('Network error! Please try again.', 'error');
    }
  }

  async function loadViewData() {
    try {
      const res = await fetch("/api/wood-bill");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      const rows = await res.json();
      const tbody = document.querySelector("#viewTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(rows)) {
        console.error("Expected array but got:", rows);
        return;
      }

      const receivers = new Set();
      const submitters = new Set();

      rows.forEach((d, i) => {
        const sapDate = d.sapDate ? d.sapDate.split('T')[0] : '';
        const billDate = d.billDate ? d.billDate.split('T')[0] : '';
        
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${sapDate}</td>
            <td>${billDate}</td>
            <td>${d.quantity}</td>
            <td>${d.submitTime}</td>
            <td>${d.receiverName}</td>
            <td>${d.submittedBy}</td>
            <td>${d.plant}</td>
          </tr>
        `;
        if (d.receiverName) receivers.add(d.receiverName);
        if (d.submittedBy) submitters.add(d.submittedBy);
      });

      // Update filters
      document.getElementById("receiverFilter").innerHTML =
        `<option value="">All Receivers</option>` +
        [...receivers].map(r => `<option value="${r}">${r}</option>`).join("");

      document.getElementById("submittedByFilter").innerHTML =
        `<option value="">All Submitters</option>` +
        [...submitters].map(s => `<option value="${s}">${s}</option>`).join("");
        
    } catch (error) {
      console.error("Error loading view data:", error);
      showAlert('Failed to load view data!', 'error');
    }
  }

  function filterView() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const receiver = document.getElementById("receiverFilter").value.toLowerCase();
    const submittedBy = document.getElementById("submittedByFilter").value.toLowerCase();
    const plant = document.getElementById("plantFilter").value;
    const searchText = document.getElementById("searchBox").value.toLowerCase();

    fetch("/api/wood-bill")
      .then(res => res.json())
      .then(data => {
        const filtered = data.filter(d => {
          const sapDate = d.sapDate ? new Date(d.sapDate).toISOString().split('T')[0] : '';
          
          const inDateRange =
            (!startDate || sapDate >= startDate) &&
            (!endDate || sapDate <= endDate);
          
          const matchesReceiver = !receiver || 
            (d.receiverName && d.receiverName.toLowerCase().includes(receiver));
          
          const matchesSubmitter = !submittedBy || 
            (d.submittedBy && d.submittedBy.toLowerCase().includes(submittedBy));
          
          const matchesPlant = !plant || d.plant === plant;
          
          const matchesSearch = !searchText || 
            Object.values(d).some(val => 
              val && String(val).toLowerCase().includes(searchText)
            );
          
          return inDateRange && matchesReceiver && matchesSubmitter && matchesPlant && matchesSearch;
        });

        const tbody = document.querySelector("#viewTable tbody");
        tbody.innerHTML = "";
        
        filtered.forEach((d, i) => {
          tbody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>${d.sapDate ? d.sapDate.split('T')[0] : ''}</td>
              <td>${d.billDate ? d.billDate.split('T')[0] : ''}</td>
              <td>${d.quantity}</td>
              <td>${d.submitTime}</td>
              <td>${d.receiverName}</td>
              <td>${d.submittedBy}</td>
              <td>${d.plant}</td>
            </tr>
          `;
        });
      })
      .catch(error => {
        console.error("Error filtering data:", error);
        showAlert('Failed to filter data!', 'error');
      });
  }

  function clearFilters() {
    document.getElementById("startDate").value = today;
    document.getElementById("endDate").value = today;
    document.getElementById("receiverFilter").value = "";
    document.getElementById("submittedByFilter").value = "";
    document.getElementById("plantFilter").value = "";
    document.getElementById("searchBox").value = "";
    filterView();
  }

  // Auto-refresh data every 30 seconds
  setInterval(() => {
    if (!isEditingMode) {
      loadSavedData();
    }
  }, 30000);

  // Listen for Enter key to save
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && isEditingMode) {
      const saveBtn = document.querySelector('.editing .save-btn');
      if (saveBtn) {
        saveBtn.click();
      }
    }
    
    if (e.key === 'Escape' && isEditingMode) {
      const cancelBtn = document.querySelector('.editing .cancel-btn');
      if (cancelBtn) {
        cancelBtn.click();
      }
    }
  });
</script>

</body>
</html>
