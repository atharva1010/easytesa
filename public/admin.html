<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Add admin-specific styles here */
    .admin-only {
      display: none;
    }
    
    .admin-controls {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    
    .admin-btn {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1rem;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .admin-btn.primary {
      background: linear-gradient(135deg, #28a745, #218838);
    }
    
    .admin-btn.warning {
      background: linear-gradient(135deg, #ffc107, #e0a800);
    }
    
    .admin-form {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .form-actions {
      margin-top: 20px;
      text-align: right;
    }
    
    .user-actions {
      display: flex;
      gap: 5px;
    }
    
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .edit-btn {
      background-color: #17a2b8;
      color: white;
    }
    
    .delete-btn {
      background-color: #dc3545;
      color: white;
    }
    
    .status-btn {
      background-color: #28a745;
      color: white;
    }
    
    /* Add this to your existing media queries */
    @media (max-width: 768px) {
      .admin-controls {
        flex-direction: column;
      }
      
      .admin-btn {
        margin-bottom: 10px;
        width: 100%;
      }
    }
  </style>
</head>
<body onload="checkAuth()">
  <!-- Add admin controls to header -->
  <header>
    <div class="logo-container">
      <button id="hamburger" class="header-icon" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <img src="assets/logo.png" alt="Logo" class="logo" onclick="goHome()">
      <span class="company-name">BALAJI ACTION BUILDEWELL - ADMIN</span>
    </div>
    
    <div class="header-controls">
      <div id="admin-notification-icon" class="header-icon" onclick="toggleAdminNotifications()">
        <i class="fas fa-cog"></i>
      </div>
      <div id="notification-icon" class="header-icon" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span id="notificationCountBadge" class="unread-count" style="display: none;">0</span>
      </div>
      <div id="message-icon" class="header-icon" onclick="toggleChatUserList()">
        <i class="fas fa-comment-dots"></i>
        <span id="messageCountBadge" class="unread-count" style="display: none;">0</span>
      </div>
      <img id="profileImage" src="assets/profile.png" class="profile-img" onclick="toggleProfileCard()">
    </div>
  </header>

  <!-- Admin Notification Panel -->
  <div id="adminNotificationPanel" class="notification-panel">
    <h4 style="margin-bottom: 1rem;"><i class="fas fa-cog"></i> Admin Controls</h4>
    <div class="admin-controls">
      <button class="admin-btn primary" onclick="showUserManagement()">
        <i class="fas fa-users"></i> Manage Users
      </button>
      <button class="admin-btn" onclick="showDataManagement()">
        <i class="fas fa-database"></i> Manage Data
      </button>
      <button class="admin-btn warning" onclick="showSystemSettings()">
        <i class="fas fa-cogs"></i> System Settings
      </button>
      <button class="admin-btn" onclick="showAuditLogs()">
        <i class="fas fa-clipboard-list"></i> Audit Logs
      </button>
    </div>
  </div>

  <!-- Add admin sections to sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-section admin-only">
      <h4>Admin Tools</h4>
      <button class="sidebar-btn" onclick="showUserManagement()">
        <i class="fas fa-users-cog"></i> User Management
      </button>
      <button class="sidebar-btn" onclick="showDataManagement()">
        <i class="fas fa-database"></i> Data Management
      </button>
      <button class="sidebar-btn" onclick="showSystemSettings()">
        <i class="fas fa-sliders-h"></i> System Settings
      </button>
    </div>
    
    <!-- Rest of your existing sidebar content -->
  </div>

  <!-- Main Content - Add admin sections -->
  <div class="content" id="mainContent" onclick="hideSidebar()">
    <!-- Admin Dashboard Section -->
    <div id="adminDashboard" class="admin-only">
      <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
      <div class="admin-stats">
        <div class="stat-card">
          <i class="fas fa-users"></i>
          <h3 id="totalUsers">0</h3>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-file-alt"></i>
          <h3 id="totalRecords">0</h3>
          <p>Total Records</p>
        </div>
        <div class="stat-card">
          <i class="fas fa-clock"></i>
          <h3 id="activeSessions">0</h3>
          <p>Active Sessions</p>
        </div>
      </div>
      
      <div class="admin-controls">
        <button class="admin-btn primary" onclick="showUserManagement()">
          <i class="fas fa-users"></i> Manage Users
        </button>
        <button class="admin-btn" onclick="showDataManagement()">
          <i class="fas fa-database"></i> Manage Data
        </button>
        <button class="admin-btn warning" onclick="showSystemSettings()">
          <i class="fas fa-cogs"></i> System Settings
        </button>
      </div>
    </div>
    
    <!-- User Management Section -->
    <div id="userManagement" class="admin-only" style="display:none;">
      <h2><i class="fas fa-users-cog"></i> User Management</h2>
      <div class="admin-controls">
        <button class="admin-btn primary" onclick="showAddUserForm()">
          <i class="fas fa-user-plus"></i> Add User
        </button>
        <button class="admin-btn" onclick="loadAllUsers()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <input type="text" id="userSearch" class="search-box" placeholder="Search users..." oninput="searchUsers()">
      </div>
      
      <div id="addUserForm" class="admin-form">
        <h3>Add New User</h3>
        <div class="form-group">
          <label for="newUsername">Username</label>
          <input type="text" id="newUsername" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="newEmail">Email</label>
          <input type="email" id="newEmail" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="newPassword">Password</label>
          <input type="password" id="newPassword" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="newRole">Role</label>
          <select id="newRole" class="form-control">
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
          </select>
        </div>
        <div class="form-group">
          <label for="newDepartment">Department</label>
          <input type="text" id="newDepartment" class="form-control">
        </div>
        <div class="form-actions">
          <button class="admin-btn" onclick="hideAddUserForm()">Cancel</button>
          <button class="admin-btn primary" onclick="addNewUser()">Save User</button>
        </div>
      </div>
      
      <div class="table-container">
        <table id="usersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Data Management Section -->
    <div id="dataManagement" class="admin-only" style="display:none;">
      <h2><i class="fas fa-database"></i> Data Management</h2>
      <div class="admin-controls">
        <button class="admin-btn primary" onclick="showUploadForm()">
          <i class="fas fa-upload"></i> Upload Data
        </button>
        <button class="admin-btn" onclick="exportAllData()">
          <i class="fas fa-download"></i> Export All
        </button>
        <button class="admin-btn warning" onclick="showBackupRestore()">
          <i class="fas fa-history"></i> Backup/Restore
        </button>
      </div>
      
      <div id="uploadForm" class="admin-form">
        <h3>Upload Data File</h3>
        <div class="form-group">
          <label for="dataCategory">Category</label>
          <select id="dataCategory" class="form-control">
            <option value="WOOD PO">WOOD PO</option>
            <option value="CONTACTS">CONTACTS</option>
            <option value="ID PASSWORD">ID PASSWORD</option>
            <option value="SHIFT SCHEDULE">SHIFT SCHEDULE</option>
            <option value="T-CODE">T-CODE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dataFile">Excel File</label>
          <input type="file" id="dataFile" class="form-control" accept=".xlsx,.xls,.csv">
        </div>
        <div class="form-actions">
          <button class="admin-btn" onclick="hideUploadForm()">Cancel</button>
          <button class="admin-btn primary" onclick="uploadDataFile()">Upload</button>
        </div>
      </div>
      
      <div id="backupRestore" class="admin-form">
        <h3>Backup & Restore</h3>
        <div class="form-group">
          <button class="admin-btn primary" onclick="createBackup()">
            <i class="fas fa-save"></i> Create Backup
          </button>
        </div>
        <div class="form-group">
          <label for="restoreFile">Restore From Backup</label>
          <input type="file" id="restoreFile" class="form-control" accept=".json,.sql,.backup">
        </div>
        <div class="form-actions">
          <button class="admin-btn warning" onclick="restoreFromBackup()">
            <i class="fas fa-history"></i> Restore
          </button>
        </div>
      </div>
    </div>
    
    <!-- System Settings Section -->
    <div id="systemSettings" class="admin-only" style="display:none;">
      <h2><i class="fas fa-cogs"></i> System Settings</h2>
      <div class="admin-controls">
        <button class="admin-btn primary" onclick="saveSystemSettings()">
          <i class="fas fa-save"></i> Save Settings
        </button>
      </div>
      
      <div class="admin-form">
        <div class="form-group">
          <label for="systemName">System Name</label>
          <input type="text" id="systemName" class="form-control" value="BALAJI ACTION BUILDEWELL">
        </div>
        <div class="form-group">
          <label for="maintenanceMode">Maintenance Mode</label>
          <select id="maintenanceMode" class="form-control">
            <option value="false">Disabled</option>
            <option value="true">Enabled</option>
          </select>
        </div>
        <div class="form-group">
          <label for="loginMethod">Login Method</label>
          <select id="loginMethod" class="form-control">
            <option value="email">Email</option>
            <option value="username">Username</option>
            <option value="both">Both</option>
          </select>
        </div>
        <div class="form-group">
          <label for="passwordPolicy">Password Policy</label>
          <select id="passwordPolicy" class="form-control">
            <option value="simple">Simple (6 chars min)</option>
            <option value="medium">Medium (8 chars, 1 number)</option>
            <option value="strong">Strong (10 chars, mixed case, special chars)</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Audit Logs Section -->
    <div id="auditLogs" class="admin-only" style="display:none;">
      <h2><i class="fas fa-clipboard-list"></i> Audit Logs</h2>
      <div class="admin-controls">
        <button class="admin-btn" onclick="refreshAuditLogs()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <input type="text" id="logSearch" class="search-box" placeholder="Search logs..." oninput="filterLogs()">
      </div>
      
      <div class="table-container">
        <table id="auditLogsTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="auditLogsBody">
            <!-- Logs will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Your existing content sections -->
  </div>

  <!-- Add to your existing scripts -->
  <script>
    // Admin-specific functions
    function checkAdminAccess() {
      const role = localStorage.getItem('role');
      if (role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('admin-notification-icon').style.display = 'block';
        loadAdminStats();
      }
    }
    
    function loadAdminStats() {
      fetch('/api/admin/stats')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('totalUsers').textContent = data.totalUsers;
            document.getElementById('totalRecords').textContent = data.totalRecords;
            document.getElementById('activeSessions').textContent = data.activeSessions;
          }
        });
    }
    
    function showUserManagement() {
      hideAllAdminSections();
      document.getElementById('userManagement').style.display = 'block';
      loadAllUsers();
    }
    
    function showDataManagement() {
      hideAllAdminSections();
      document.getElementById('dataManagement').style.display = 'block';
    }
    
    function showSystemSettings() {
      hideAllAdminSections();
      document.getElementById('systemSettings').style.display = 'block';
      loadSystemSettings();
    }
    
    function showAuditLogs() {
      hideAllAdminSections();
      document.getElementById('auditLogs').style.display = 'block';
      loadAuditLogs();
    }
    
    function hideAllAdminSections() {
      document.querySelectorAll('.admin-only > div').forEach(el => {
        if (el.id !== 'adminDashboard') el.style.display = 'none';
      });
    }
    
    function showAddUserForm() {
      document.getElementById('addUserForm').style.display = 'block';
    }
    
    function hideAddUserForm() {
      document.getElementById('addUserForm').style.display = 'none';
    }
    
    function showUploadForm() {
      document.getElementById('uploadForm').style.display = 'block';
      document.getElementById('backupRestore').style.display = 'none';
    }
    
    function hideUploadForm() {
      document.getElementById('uploadForm').style.display = 'none';
    }
    
    function showBackupRestore() {
      document.getElementById('backupRestore').style.display = 'block';
      document.getElementById('uploadForm').style.display = 'none';
    }
    
    function loadAllUsers() {
      fetch('/api/admin/users')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            data.users.forEach(user => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${user.userId}</td>
                <td>${user.username}</td>
                <td>${user.email || '-'}</td>
                <td>${user.role}</td>
                <td>${user.department || '-'}</td>
                <td>
                  <button class="status-btn action-btn" onclick="toggleUserStatus('${user.userId}', ${user.active})">
                    ${user.active ? 'Active' : 'Inactive'}
                  </button>
                </td>
                <td class="user-actions">
                  <button class="edit-btn action-btn" onclick="editUser('${user.userId}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-btn action-btn" onclick="deleteUser('${user.userId}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
        });
    }
    
    function addNewUser() {
      const userData = {
        username: document.getElementById('newUsername').value,
        email: document.getElementById('newEmail').value,
        password: document.getElementById('newPassword').value,
        role: document.getElementById('newRole').value,
        department: document.getElementById('newDepartment').value
      };
      
      fetch('/api/admin/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(userData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('User added successfully');
          hideAddUserForm();
          loadAllUsers();
          resetAddUserForm();
        } else {
          showToast(data.message || 'Failed to add user');
        }
      });
    }
    
    function resetAddUserForm() {
      document.getElementById('newUsername').value = '';
      document.getElementById('newEmail').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('newRole').value = 'user';
      document.getElementById('newDepartment').value = '';
    }
    
    function editUser(userId) {
      // Implementation for editing a user
      showToast('Edit user: ' + userId);
    }
    
    function deleteUser(userId) {
      if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('User deleted successfully');
            loadAllUsers();
          } else {
            showToast(data.message || 'Failed to delete user');
          }
        });
      }
    }
    
    function toggleUserStatus(userId, currentStatus) {
      fetch(`/api/admin/users/${userId}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ active: !currentStatus })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('User status updated');
          loadAllUsers();
        } else {
          showToast(data.message || 'Failed to update status');
        }
      });
    }
    
    function uploadDataFile() {
      const category = document.getElementById('dataCategory').value;
      const fileInput = document.getElementById('dataFile');
      
      if (fileInput.files.length === 0) {
        showToast('Please select a file to upload');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('category', category);
      
      fetch('/api/admin/upload-data', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('Data uploaded successfully');
          hideUploadForm();
          fileInput.value = '';
        } else {
          showToast(data.message || 'Failed to upload data');
        }
      });
    }
    
    function exportAllData() {
      fetch('/api/admin/export-data', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'system_data_export_' + new Date().toISOString().split('T')[0] + '.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      });
    }
    
    function createBackup() {
      fetch('/api/admin/create-backup', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'system_backup_' + new Date().toISOString().split('T')[0] + '.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        showToast('Backup created successfully');
      });
    }
    
    function restoreFromBackup() {
      const fileInput = document.getElementById('restoreFile');
      
      if (fileInput.files.length === 0) {
        showToast('Please select a backup file');
        return;
      }
      
      if (!confirm('WARNING: This will overwrite current data. Continue?')) {
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      fetch('/api/admin/restore-backup', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('System restored from backup');
          fileInput.value = '';
        } else {
          showToast(data.message || 'Failed to restore backup');
        }
      });
    }
    
    function loadSystemSettings() {
      fetch('/api/admin/settings', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('systemName').value = data.settings.systemName || 'BALAJI ACTION BUILDEWELL';
          document.getElementById('maintenanceMode').value = data.settings.maintenanceMode ? 'true' : 'false';
          document.getElementById('loginMethod').value = data.settings.loginMethod || 'email';
          document.getElementById('passwordPolicy').value = data.settings.passwordPolicy || 'medium';
        }
      });
    }
    
    function saveSystemSettings() {
      const settings = {
        systemName: document.getElementById('systemName').value,
        maintenanceMode: document.getElementById('maintenanceMode').value === 'true',
        loginMethod: document.getElementById('loginMethod').value,
        passwordPolicy: document.getElementById('passwordPolicy').value
      };
      
      fetch('/api/admin/settings', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(settings)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('Settings saved successfully');
        } else {
          showToast(data.message || 'Failed to save settings');
        }
      });
    }
    
    function loadAuditLogs() {
      fetch('/api/admin/audit-logs', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('auditLogsBody');
          tbody.innerHTML = '';
          
          data.logs.forEach(log => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(log.timestamp).toLocaleString()}</td>
              <td>${log.userId || 'System'}</td>
              <td>${log.action}</td>
              <td>${log.details || '-'}</td>
              <td>${log.ipAddress || '-'}</td>
            `;
            tbody.appendChild(tr);
          });
        }
      });
    }
    
    function refreshAuditLogs() {
      loadAuditLogs();
    }
    
    function filterLogs() {
      const searchTerm = document.getElementById('logSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#auditLogsBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }
    
    function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#usersTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }
    
    function toggleAdminNotifications() {
      const panel = document.getElementById('adminNotificationPanel');
      panel.classList.toggle('show');
      
      if (panel.classList.contains('show')) {
        hideNotifications();
        hideChatUserList();
        hideProfileCard();
      }
    }
    
    // Modify your existing initApp function to check admin access
    function initApp() {
      checkMobile();
      setupEventListeners();
      loadUserProfile();
      checkAdminAccess(); // Add this line
      
      // Rest of your existing init code...
    }
    
    // Add this to your existing checkAuth function
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return;
      }
      initApp();
    }
  </script>
</body>
</html>
