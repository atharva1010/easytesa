<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>User Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --darker: #0f172a;
      --light: #f8fafc;
      --gray: #94a3b8;
      --success: #22c55e;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --neon-blue: #00f7ff;
      --neon-pink: #ff0080;
      --neon-purple: #7b2ff7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: var(--light);
      overflow-x: hidden;
    }

    /* Header Styles */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      border-bottom: 1px solid var(--glass-border);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo {
      height: 35px;
      filter: drop-shadow(0 0 8px var(--neon-blue));
    }

    .company-name {
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 8px rgba(0, 247, 255, 0.3);
      display: none;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    /* Mobile Splash Screen */
    .mobile-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      z-index: 2000;
      transition: opacity 0.5s ease;
    }

    .mobile-splash.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .mobile-splash-logo {
      width: 150px;
      height: 150px;
      filter: drop-shadow(0 0 15px var(--neon-blue));
      margin-bottom: 2rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Rest of your existing CSS remains the same until... */

    /* Desktop Styles */
    @media (min-width: 768px) {
      header {
        height: 70px;
        padding: 0 2rem;
      }

      .company-name {
        display: block;
        font-size: 1.2rem;
      }

      .header-controls {
        gap: 1.5rem;
      }

      .header-icon {
        font-size: 1.4rem;
      }

      .profile-img {
        width: 40px;
        height: 40px;
      }

      .bottom-nav {
        display: none;
      }

      .content {
        margin-top: 70px;
        padding: 2rem;
        margin-bottom: 0;
      }

      .content.expanded {
        margin-left: 250px;
      }

      .filters {
        flex-direction: row;
        align-items: center;
      }

      .search-box {
        min-width: 250px;
      }

      .data-buttons {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.8rem;
      }

      .data-btn {
        font-size: 0.9rem;
      }

      footer {
        display: block;
        bottom: 0;
      }

      .profile-card {
        top: 80px;
      }

      .notification-panel {
        top: 80px;
        width: 350px;
      }

      .chat-user-list {
        top: 80px;
        width: 300px;
      }

      .chat-box {
        bottom: 20px;
        width: 350px;
      }

      /* Hide mobile splash in desktop view */
      .mobile-splash {
        display: none;
      }
    }

    /* Mobile Landscape */
    @media (max-height: 500px) and (orientation: landscape) {
      .content {
        margin-bottom: 0;
      }

      footer {
        display: none;
      }
    }
  </style>
</head>
<body onload="initApp()">
  <!-- Mobile Splash Screen -->
  <div id="mobileSplash" class="mobile-splash">
    <img src="assets/logo.png" alt="Logo" class="mobile-splash-logo">
  </div>

  <!-- Header -->
  <header>
    <div class="logo-container">
      <button id="hamburger" class="header-icon" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <img src="assets/logo.png" alt="Logo" class="logo" onclick="goHome()">
      <span class="company-name">BALAJI ACTION BUILDEWELL</span>
    </div>
    
    <div class="header-controls">
      <div id="notification-icon" class="header-icon" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span id="notification-dot" class="notification-badge" style="display: none;"></span>
      </div>
      
      <div id="message-icon" class="header-icon" onclick="toggleChatUserList()">
        <i class="fas fa-comment-dots"></i>
        <span id="messageNotifyDot" class="notification-badge" style="display: none;"></span>
      </div>
      
      <img id="profileImage" src="assets/profile.png" class="profile-img" onclick="toggleProfileCard()">
    </div>
    
    <!-- Profile Card -->
    <div id="profileCard" class="profile-card">
      <div class="profile-info">
        <h3 id="profile-name">Loading...</h3>
        <p><strong>User ID:</strong> <span id="profile-id">-</span></p>
        <p><strong>Email:</strong> <span id="profile-email">-</span></p>
        <p><strong>Mobile:</strong> <span id="profile-mobile">-</span></p>
        <p><strong>Department:</strong> <span id="profile-dept">-</span></p>
        <p><strong>Designation:</strong> <span id="profile-designation">-</span></p>
        <p><strong>Role:</strong> <span id="profile-role">-</span></p>
      </div>
      <button onclick="logout()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <!-- Rest of your HTML remains the same... -->

  <script>
    // Global variables
    let originalData = [];
    let currentUser = null;
    let currentCategory = '';
    let allMessages = [];
    let activeChatUser = null;
    const userId = localStorage.getItem("userId");
    const userElements = {};
    const unreadSenders = new Set();
    const notifySound = new Audio("/assets/notification.mp3");
    let isMobile = false;
    let socket = null;

    // Initialize the app
    function initApp() {
      checkMobile();
      setupEventListeners();
      
      // Hide splash screen after 2 seconds or when any button is clicked
      setTimeout(hideSplash, 2000);
      
      loadUserProfile();
      
      if (userId) {
        // Initialize socket connection only if user is logged in
        socket = io();
        socket.emit("join", userId);
        setupSocketListeners();
      }
      
      initNotifications();
    }

    // Hide splash screen
    function hideSplash() {
      const splash = document.getElementById('mobileSplash');
      if (splash) {
        splash.classList.add('hidden');
      }
    }

    // Check if device is mobile
    function checkMobile() {
      isMobile = window.matchMedia("(max-width: 768px)").matches || 
                window.matchMedia("(max-height: 500px)").matches;
      
      if (isMobile) {
        document.getElementById('bottomNav').style.display = 'flex';
        document.getElementById('topButtons').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        
        // Hide content initially in mobile view
        document.getElementById('tableSection').style.display = 'none';
      } else {
        document.getElementById('bottomNav').style.display = 'none';
        document.getElementById('topButtons').style.display = 'grid';
        document.querySelector('footer').style.display = 'block';
        
        // Show content in desktop view
        document.getElementById('tableSection').style.display = 'block';
      }
    }

    // Load table data - MODIFIED FOR MOBILE
    function loadTable(category) {
      // Hide splash screen when any button is clicked
      hideSplash();
      
      // Show table section in mobile view
      if (isMobile) {
        document.getElementById('tableSection').style.display = 'block';
      }
      
      currentCategory = category;
      fetch(`/api/excel-data/${category}`)
        .then(res => res.json())
        .then(res => {
          if (res.success) {
            originalData = res.data;
            renderTable(res.data);

            const filter = document.getElementById("materialFilter");
            if (category === 'WOOD PO') {
              const materialSet = new Set(res.data.slice(1).map(row => row[3]));
              filter.innerHTML = '<option value="">All Materials</option>' + [...materialSet].map(m => `<option>${m}</option>`).join('');
              filter.style.display = 'block';
            } else {
              filter.style.display = 'none';
            }
          }
        });
    }



          

// Load chat users
function loadChatUsers() {
  fetch("/api/users")
    .then(res => res.json())
    .then(users => {
      const container = document.getElementById("userListContainer");
      container.innerHTML = '';

      users.filter(u => u.userId !== userId).forEach(user => {
        const div = document.createElement("div");
        div.className = "chat-user-item";
        div.innerHTML = `
          <img src="${user.profilePic || 'assets/profile.png'}" class="chat-user-avatar">
          <div class="chat-user-info">
            <div class="chat-user-name">${user.username}</div>
            <div class="chat-user-status">${user.department}</div>
          </div>
          <span class="msg-count" style="display: none;"></span>
        `;
        div.onclick = () => openChatWith(user);
        container.appendChild(div);

        

// Load table data
function loadTable(category) {
  currentCategory = category;
  fetch(`/api/excel-data/${category}`)
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        originalData = res.data;
        renderTable(res.data);

        const filter = document.getElementById("materialFilter");
        if (category === 'WOOD PO') {
          const materialSet = new Set(res.data.slice(1).map(row => row[3]));
          filter.innerHTML = '<option value="">All Materials</option>' + [...materialSet].map(m => `<option>${m}</option>`).join('');
          filter.style.display = 'block';
        } else {
          filter.style.display = 'none';
        }
      }
    });
}

// Render table
function renderTable(data) {
  const thead = document.querySelector("#dataTable thead");
  const tbody = document.querySelector("#dataTable tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (data.length === 0) return;

  const table = document.getElementById("dataTable");
  table.className = currentCategory === 'SHIFT SCHEDULE' ? 'shift-schedule-freeze' : '';

  // Create header row
  const headerRow = document.createElement("tr");
  data[0].forEach((col, index) => {
    const th = document.createElement("th");
    th.textContent = col;
    if (currentCategory === 'SHIFT SCHEDULE' && index < 5) {
      th.classList.add('freeze-col');
    }
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // Create data rows
  data.slice(1).forEach((row, rowIndex) => {
    const tr = document.createElement("tr");

    const rowText = row.map(cell => String(cell).toUpperCase()).join(" ");
    if (currentCategory === 'WOOD PO') {
      if (rowText.includes("RAMPUR")) tr.style.background = "rgba(144, 238, 144, 0.2)";
      else if (rowText.includes("SITAPUR")) tr.style.background = "rgba(255, 0, 255, 0.2)";
      else if (rowText.includes("OTHER")) tr.style.background = "rgba(255, 255, 0, 0.2)";
    }

    row.forEach((cell, colIndex) => {
      const td = document.createElement("td");
      const value = typeof cell === 'object' ? (cell.text || '') : String(cell);

      if (currentCategory === 'WOOD PO' && colIndex === 0) {
        td.innerHTML = `<button onclick="copyText('${value}', 'PO Copied')" style="background:var(--primary); color:white; border:none; padding:0.3rem 0.6rem; border-radius:4px; cursor:pointer;">${value}</button>`;
      } else if (currentCategory === 'ID PASSWORD' && colIndex === 1) {
        td.innerHTML = `<button onclick="copyText('${value}', 'Password Copied')" style="background:var(--success); color:white; border:none; padding:0.3rem 0.6rem; border-radius:4px; cursor:pointer;">******</button>`;
      } else {
        td.textContent = value;
      }

      if (currentCategory === 'SHIFT SCHEDULE') {
        if (rowIndex < 2 || colIndex < 5) td.style.background = 'rgba(173, 216, 230, 0.3)';
        if (value === 'R') td.style.background = 'rgba(0, 100, 0, 0.3)';
        else if (value === 'L') td.style.background = 'rgba(139, 0, 0, 0.3)';
        else if (value === 'G') td.style.background = 'rgba(184, 134, 11, 0.3)';
      }

      if (currentCategory === 'SHIFT SCHEDULE' && colIndex < 5) {
        td.classList.add('freeze-col');
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

// Copy text to clipboard
function copyText(text, message) {
  navigator.clipboard.writeText(text).then(() => {
    showToast(message);
  }).catch(err => {
    console.error("Copy failed", err);
  });
}

// Show toast notification
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => {
      toast.style.display = 'none';
      toast.style.animation = 'fadeIn 0.3s ease';
    }, 300);
  }, 2000);
}

// Apply filters to table
function applyFilters() {
  let filtered = [...originalData];
  const searchVal = document.getElementById("searchBox").value.toLowerCase();
  const materialVal = document.getElementById("materialFilter").value;

  if (searchVal) {
    filtered = filtered.filter(row => row.some(cell => String(cell).toLowerCase().includes(searchVal)));
  }
  if (materialVal) {
    filtered = filtered.filter(row => row[3] === materialVal);
  }

  renderTable([originalData[0], ...filtered]);
}

// Show team modal
function showTeam() {
  document.getElementById('teamModal').classList.add('show');
  fetch('/api/users')
    .then(res => res.json())
    .then(users => {
      const container = document.getElementById('teamContainer');
      container.innerHTML = users.map(user => `
        <div class="user-card">
          <img src="${user.profilePic || 'assets/profile.png'}" class="user-avatar">
          <div class="user-name">${user.username}</div>
          <div class="user-detail"><strong>ID:</strong> ${user.userId}</div>
          <div class="user-detail"><strong>Dept:</strong> ${user.department}</div>
          <div class="user-detail"><strong>Role:</strong> ${user.designation}</div>
          <div class="user-detail"><strong>Email:</strong> ${user.email || '-'}</div>
        </div>
      `).join('');
    });
}

// Hide team modal
function hideTeam() {
  document.getElementById('teamModal').classList.remove('show');
}

// Open register form in iframe
function openRegister(type) {
  const iframe = document.getElementById("registerIframe");
  const iframeContainer = document.getElementById("iframeContainer");
  const tableSection = document.getElementById("tableSection");
  const topButtons = document.getElementById("topButtons");

  let page = "";
  switch(type) {
    case 'wood': page = "wood-bill-register.html"; break;
    case 'methanol': page = "methanol-register.html"; break;
    case 'longbody': page = "longbody-register.html"; break;
    case 'shift': page = "shift-register.html"; break;
    case 'download': page = "Download.html"; break;
    case 'sop': page = "SOP.html"; break;  
    case 'stickerGenrator': page = "StickerGenrator.html"; break;
    case 'about': page = "About.html"; break;   
  }

  iframe.src = page;
  iframeContainer.style.display = "block";
  tableSection.style.display = "none";
  topButtons.style.display = "none";
  hideSidebar();
}

// Show desktop notification
function showDesktopNotification(title, body) {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, {
      body: body,
      icon: "/assets/profile.png"
    });
  }
}

// Play notification sound
function playNotificationSound() {
  notifySound.play().catch(e => console.warn("Audio play failed:", e));
}

// Show message notification dot
function showMessageNotificationDot() {
  document.getElementById("messageNotifyDot").style.display = "block";
}

// Add red badge to user
function addBadge(el) {
  let badge = el.querySelector('.msg-count');
  if (!badge) {
    badge = document.createElement('span');
    badge.className = 'msg-count';
    badge.textContent = '1';
    el.appendChild(badge);
  } else {
    badge.textContent = parseInt(badge.textContent) + 1;
  }
  badge.style.display = 'block';
}

// Open chat with a user
function openChatWith(user) {
  activeChatUser = user;
  document.getElementById("chatWith").innerHTML = `<i class="fas fa-user"></i> Chat with ${user.username}`;
  document.getElementById("chatBox").classList.add('show');
  document.getElementById("chatMessages").innerHTML = '';
  document.getElementById("chatInput").value = '';

  const el = userElements[user.userId];
  if (el) {
    const badge = el.querySelector(".msg-count");
    if (badge) badge.remove();
  }

  unreadSenders.delete(user.userId);

  // Hide icon red dot if none left
  if (unreadSenders.size === 0) {
    document.getElementById("messageNotifyDot").style.display = "none";
  }

  renderMessages();
}

// Show all messages between active users
function renderMessages() {
  const box = document.getElementById("chatMessages");
  box.innerHTML = "";

  const msgs = allMessages.filter(m =>
    (m.from === userId && m.to === activeChatUser.userId) ||
    (m.to === userId && m.from === activeChatUser.userId)
  );

  msgs.forEach(m => appendMessage(m));
}

// Add one message to the box
function appendMessage(msg) {
  const box = document.getElementById("chatMessages");
  const isMe = msg.from === userId;
  
  const messageDiv = document.createElement("div");
  messageDiv.className = `message message-${isMe ? 'outgoing' : 'incoming'}`;
  
  const senderDiv = document.createElement("div");
  senderDiv.className = "message-sender";
  senderDiv.textContent = isMe ? "You" : msg.from;
  
  const contentDiv = document.createElement("div");
  contentDiv.className = "message-content";
  contentDiv.textContent = msg.message;
  
  messageDiv.appendChild(senderDiv);
  messageDiv.appendChild(contentDiv);
  box.appendChild(messageDiv);
  
  box.scrollTop = box.scrollHeight;
}

// Send message to server
function sendMessage() {
  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if (!message || !activeChatUser) return;

  const msg = {
    from: userId,
    to: activeChatUser.userId,
    message
  };

  // Emit message through socket
  socket.emit("chatMessage", msg);
  
  // Add message to local array
  allMessages.push(msg);
  
  // Append message to chat
  appendMessage(msg);
  
  // Clear input
  input.value = "";
}

// Close chat window
function closeChat() {
  document.getElementById("chatBox").classList.remove('show');
  activeChatUser = null;
}

// Go to home page
function goHome() {
  window.location.href = 'dashboard.html';
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
